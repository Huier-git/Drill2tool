# 机构控制器操作逻辑详解

## 概述

本文档详细描述每个机构控制器的操作步骤逻辑，包括状态转换、定时器使用和传感器（编码器）判断条件。

---

## 1. ClampController (Cb) - 下夹紧

### 1.1 close() - 闭合夹紧

```
┌─────────────────────────────────────────────────────────────────┐
│                    close(double torque)                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查驱动和状态   │
                    │ isReady()?      │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │ 否                          │ 是
              ▼                             ▼
        ┌──────────┐              ┌─────────────────────┐
        │ 返回false │              │ 确定夹紧力矩        │
        └──────────┘              │ torque > 0 ?        │
                                  │   用参数值          │
                                  │   否则用 m_torque   │
                                  └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤1: 切换到力矩模式│
                                  │ setAxisType(Torque) │
                                  └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤2: 施加夹紧力矩  │
                                  │ setDAC(closeTorque) │
                                  │ closeDAC = 100      │
                                  └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤3: 更新状态      │
                                  │ m_state = Closing   │
                                  │ emit stateChanged() │
                                  └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤4: 启动延时定时器│
                                  │ QTimer::singleShot  │
                                  │ (1000ms)            │
                                  └──────────┬──────────┘
                                             │
                              ┌──────────────┴──────────────┐
                              │ 立即返回 true               │
                              └─────────────────────────────┘

                        === 1秒后回调 ===

                                  ┌─────────────────────┐
                                  │ 检查状态是否仍为    │
                                  │ Closing?            │
                                  └──────────┬──────────┘
                                             │
                              ┌──────────────┴──────────────┐
                              │ 是                          │ 否(被中断)
                              ▼                             ▼
                    ┌─────────────────────┐           ┌──────────┐
                    │ 步骤5: 读取当前位置  │           │ 什么都不做│
                    │ getActualPosition() │           └──────────┘
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │ 步骤6: 切换到位置模式│
                    │ setAxisType(Position)│
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │ 步骤7: 锁定当前位置  │
                    │ setTargetPosition   │
                    │ (currentPos)        │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │ 步骤8: 更新状态      │
                    │ m_state = Closed    │
                    │ state → Holding     │
                    │ emit stateChanged() │
                    └─────────────────────┘
```

**代码对应** (`ClampController.cpp:119-157`):
```cpp
bool ClampController::close(double torque)
{
    // 1. 检查状态
    if (!checkDriver() || !isReady()) {
        setError("Controller not ready");
        return false;
    }

    // 2. 确定力矩值
    double closeTorque = (torque > 0) ? torque : m_torque;
    int motorId = m_config.motor.motorId;

    // 3. 切换到力矩模式
    driver()->setAxisType(motorId, static_cast<int>(MotorMode::Torque));

    // 4. 施加夹紧力矩
    driver()->setDAC(motorId, closeTorque);

    // 5. 更新状态
    m_state = ClampState::Closing;
    setState(MechanismState::Moving, "Closing clamp");
    emit stateChanged(m_state);

    // 6. 延时1秒后锁定位置
    QTimer::singleShot(1000, this, [this]() {
        if (m_state == ClampState::Closing) {
            int motorId = m_config.motor.motorId;
            double currentPos = driver()->getActualPosition(motorId);

            // 切换到位置模式锁定
            driver()->setAxisType(motorId, static_cast<int>(MotorMode::Position));
            driver()->setTargetPosition(motorId, currentPos);

            m_state = ClampState::Closed;
            setState(MechanismState::Holding, "Clamp closed");
            emit stateChanged(m_state);
        }
    });

    return true;
}
```

### 1.2 initializeClamp() - 找零点

```
┌─────────────────────────────────────────────────────────────────┐
│                      initializeClamp()                           │
│                      找零点初始化流程                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 步骤1: 切换到   │
                    │ 力矩模式        │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 步骤2: 施加反向 │
                    │ 力矩 (DAC=-50)  │
                    │ 向张开方向运动   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 步骤3: 记录     │
                    │ 初始位置        │
                    │ m_lastPosition  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 步骤4: 启动     │
                    │ 监控定时器      │
                    │ 200ms 间隔      │
                    └────────┬────────┘
                             │
            ═══════════════════════════════════
            ║      monitorInit() 定时器回调    ║
            ═══════════════════════════════════
                             │
                             ▼
                    ┌─────────────────┐
                    │ 读取当前位置    │
                    │ currentPos      │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────────────┐
                    │ 计算位置变化            │
                    │ posChange =             │
                    │ |currentPos-lastPos|    │
                    └────────┬────────────────┘
                             │
              ┌──────────────┴──────────────┐
              │ posChange < 1.0?            │
              │ (位置稳定)                   │
              └──────────────┬──────────────┘
                   │                    │
                   │ 是                 │ 否
                   ▼                    ▼
          ┌────────────────┐    ┌────────────────┐
          │ stableCount++  │    │ stableCount=0  │
          └───────┬────────┘    │ 更新lastPos    │
                  │             └────────────────┘
                  │                    │
                  ▼                    │
          ┌────────────────┐          │
          │ stableCount>=5?│          │
          └───────┬────────┘          │
                  │                   │
           ┌──────┴──────┐            │
           │ 是          │ 否         │
           ▼             └────────────┤
    ┌──────────────┐                  │
    │ 到达机械限位! │                  │
    │ (堵转检测)   │                  │
    └──────┬───────┘                  │
           │                          │
           ▼                          │
    ┌──────────────┐                  │
    │ 停止力矩输出 │                  │
    │ setDAC(0)    │                  │
    └──────┬───────┘                  │
           │                          │
           ▼                          │
    ┌──────────────┐                  │
    │ 切换位置模式 │                  │
    └──────┬───────┘                  │
           │                          │
           ▼                          │
    ┌──────────────┐                  │
    │ 设置当前位置 │                  │
    │ 为零点       │                  │
    │ setActualPos │                  │
    │ (0.0)        │                  │
    └──────┬───────┘                  │
           │                          │
           ▼                          │
    ┌──────────────┐                  │
    │ 状态 = Open  │                  │
    │ 初始化完成!  │◄─────────────────┘
    └──────────────┘         (继续下一次定时器回调)
```

**判断条件**：
- 位置变化阈值: `positionTolerance = 1.0` 脉冲
- 稳定计数阈值: `stableCount = 5` 次
- 监控间隔: `200ms`
- **到位条件**: 连续5次(1秒)位置变化<1脉冲 → 认为堵转到位

---

## 2. PercussionController (Pi) - 冲击

### 2.1 unlock() - 解锁冲击电机

```
┌─────────────────────────────────────────────────────────────────┐
│                         unlock()                                 │
│                    解锁冲击电机流程                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查: 已经解锁? │
                    │ m_isLocked?     │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │ 已解锁                      │ 仍锁定
              ▼                             ▼
        ┌──────────┐              ┌─────────────────────┐
        │ 返回true │              │ 步骤1: 切换到力矩模式│
        └──────────┘              └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤2: 施加反向力矩  │
                                  │ setDAC(unlockDAC)   │
                                  │ unlockDAC = -30     │
                                  └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤3: 记录初始位置  │
                                  │ 记录稳定开始时间    │
                                  └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤4: 启动监控定时器│
                                  │ 100ms 间隔          │
                                  └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤5: 启动超时定时器│
                                  │ 10秒 超时           │
                                  └──────────┬──────────┘
                                             │
            ═══════════════════════════════════════════
            ║     monitorUnlock() 定时器回调 (100ms)   ║
            ═══════════════════════════════════════════
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 读取当前位置        │
                                  │ 计算位置变化        │
                                  └──────────┬──────────┘
                                             │
                              ┌──────────────┴──────────────┐
                              │ posChange < 1.0?           │
                              │ (位置稳定)                  │
                              └──────────────┬──────────────┘
                                   │                    │
                                   │ 是                 │ 否
                                   ▼                    ▼
                          ┌────────────────┐    ┌────────────────┐
                          │ 计算稳定时间   │    │ 重置稳定时间   │
                          │ stableTimeMs   │    │ 更新lastPos    │
                          └───────┬────────┘    └───────┬────────┘
                                  │                     │
                                  ▼                     │
                          ┌────────────────┐           │
                          │ stableTimeMs   │           │
                          │ >= 3000ms?     │           │
                          └───────┬────────┘           │
                                  │                    │
                           ┌──────┴──────┐             │
                           │ 是          │ 否          │
                           ▼             └─────────────┤
                    ┌──────────────┐                   │
                    │ 解锁成功!    │                   │
                    │ 位置稳定3秒  │                   │
                    └──────┬───────┘                   │
                           │                           │
                           ▼                           │
                    ┌──────────────┐                   │
                    │ 停止定时器   │                   │
                    └──────┬───────┘                   │
                           │                           │
                           ▼                           │
                    ┌──────────────┐                   │
                    │ 切换位置模式 │                   │
                    │ 锁定当前位置 │                   │
                    └──────┬───────┘                   │
                           │                           │
                           ▼                           │
                    ┌──────────────┐                   │
                    │ m_isLocked   │                   │
                    │ = false      │◄──────────────────┘
                    │ emit unlock  │     (继续下一次回调)
                    │ Completed    │
                    │ (true)       │
                    └──────────────┘

            ═══════════════════════════════════════════
            ║        onUnlockTimeout() 超时回调        ║
            ═══════════════════════════════════════════
                           │
                           ▼
                    ┌──────────────┐
                    │ 解锁失败!    │
                    │ 停止力矩输出 │
                    │ setDAC(0)    │
                    │ emit unlock  │
                    │ Completed    │
                    │ (false)      │
                    └──────────────┘
```

**判断条件**：
- 位置稳定阈值: `positionTolerance = 1.0` 脉冲
- 稳定持续时间: `stableTime = 3000ms` (3秒)
- 监控间隔: `100ms`
- 超时时间: `10秒`
- **解锁成功条件**: 位置变化<1脉冲，连续保持3秒

### 2.2 startPercussion() - 开始冲击

```
┌─────────────────────────────────────────────────────────────────┐
│                startPercussion(double frequency)                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查: 是否锁定? │
                    │ m_isLocked?     │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │ 是(锁定)                    │ 否(已解锁)
              ▼                             ▼
        ┌────────────────┐        ┌─────────────────────┐
        │ setError()     │        │ 步骤1: 设置频率     │
        │ "请先解锁"     │        │ frequency > 0 ?     │
        │ 返回 false     │        │   用参数值          │
        └────────────────┘        │   否则用默认值 (5Hz)│
                                  └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤2: 频率转速度   │
                                  │ speed = freq * 1000│
                                  └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤3: 切换速度模式 │
                                  │ setAxisType(Velocity)│
                                  └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤4: 设置速度     │
                                  │ setSpeed(speed)     │
                                  └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤5: 开始连续运动 │
                                  │ moveContinuous(1)   │
                                  └──────────┬──────────┘
                                             │
                                             ▼
                                  ┌─────────────────────┐
                                  │ 步骤6: 更新状态     │
                                  │ m_isPercussing=true │
                                  │ state → Moving      │
                                  └─────────────────────┘
```

**前置条件**: 必须先调用 `unlock()` 解锁成功后才能冲击

---

## 3. ArmGripController (Mg) - 机械手夹紧

### 3.1 initializeGrip() - 渐进力矩找零点

```
┌─────────────────────────────────────────────────────────────────┐
│                      initializeGrip()                            │
│                   渐进力矩找零点流程                              │
│              (与 ClampController 不同的策略)                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 步骤1: 切换到   │
                    │ 力矩模式        │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 步骤2: 从小力矩 │
                    │ 开始            │
                    │ m_currentDAC =  │
                    │ initDAC (10)    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 步骤3: 施加力矩 │
                    │ setDAC(10)      │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 步骤4: 启动监控 │
                    │ 定时器 (200ms)  │
                    └────────┬────────┘
                             │
            ═══════════════════════════════════
            ║     monitorInit() 定时器回调    ║
            ═══════════════════════════════════
                             │
                             ▼
                    ┌─────────────────┐
                    │ 读取当前位置    │
                    │ 计算位置变化    │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │ posChange < 1.0?            │
              │ (位置稳定)                   │
              └──────────────┬──────────────┘
                   │                    │
                   │ 是(堵转)           │ 否(还在动)
                   ▼                    ▼
          ┌────────────────┐    ┌────────────────────┐
          │ stableCount++  │    │ stableCount = 0    │
          └───────┬────────┘    │ 更新 lastPosition  │
                  │             └─────────┬──────────┘
                  │                       │
                  ▼                       ▼
          ┌────────────────┐    ┌────────────────────┐
          │ stableCount>=5?│    │ 增大力矩!          │
          └───────┬────────┘    │ currentDAC +=      │
                  │             │ dacIncrement (10)  │
           ┌──────┴──────┐      └─────────┬──────────┘
           │ 是          │ 否             │
           ▼             │                ▼
    ┌──────────────┐     │      ┌────────────────────┐
    │ 到达机械限位!│     │      │ currentDAC < 80?   │
    │ 初始化成功   │     │      │ (未到最大力矩)     │
    └──────┬───────┘     │      └─────────┬──────────┘
           │             │           │          │
           │             │           │ 是       │ 否
           │             │           ▼          ▼
           │             │    ┌──────────┐  ┌──────────┐
           │             │    │ 继续增大 │  │ 保持最大 │
           │             │    │ 力矩     │  │ 力矩     │
           │             │    └────┬─────┘  └────┬─────┘
           │             │         │             │
           │             │         └──────┬──────┘
           │             │                │
           │             └────────────────┤
           │                              │
           ▼                              │
    ┌──────────────┐                      │
    │ 停止力矩输出 │                      │
    │ 切换位置模式 │                      │
    │ 设为零点     │◄─────────────────────┘
    │ 状态=Closed  │      (继续下一次定时器回调)
    └──────────────┘
```

**与 ClampController 的区别**：
| 特性 | ClampController | ArmGripController |
|------|-----------------|-------------------|
| 力矩策略 | 固定力矩 (-50) | 渐进力矩 (10→80) |
| 初始力矩 | -50 | 10 |
| 力矩增量 | - | +10 每次 |
| 最大力矩 | - | 80 |

**判断条件**：
- 位置稳定阈值: `stableThreshold = 1.0`
- 稳定计数: `stableCount = 5`
- 力矩增量: `dacIncrement = 10`
- 最大力矩: `maxDAC = 80`

### 3.2 close() - 闭合夹爪

```
close(double torque)
    │
    ├─► 切换到力矩模式
    │   setAxisType(Torque)
    │
    ├─► 施加夹紧力矩
    │   setDAC(closeDAC=100 或 参数torque)
    │
    ├─► 状态 = Closing
    │
    └─► 延时 1秒后:
        │
        ├─► 读取当前位置
        │   getActualPosition()
        │
        ├─► 切换到位置模式
        │   setAxisType(Position)
        │
        ├─► 锁定当前位置
        │   setTargetPosition(currentPos)
        │
        └─► 状态 = Closed
```

---

## 4. ArmExtensionController (Me) - 机械手伸缩

### 4.1 initializePosition() - 找零点

```
initializePosition()
    │
    ├─► 切换到力矩模式
    │
    ├─► 施加回收方向力矩
    │   setDAC(initDAC = -50)
    │   (负值=向回收方向运动)
    │
    ├─► 启动监控定时器 (200ms)
    │
    └─► monitorInit() 定时器回调:
        │
        ├─► 读取当前位置
        │
        ├─► 位置变化 < 1.0 ?
        │   │
        │   ├─► 是: stableCount++
        │   │       └─► stableCount >= 5 ?
        │   │           └─► 是: 堵转到位!
        │   │               ├─► 停止力矩
        │   │               ├─► 切换位置模式
        │   │               ├─► 设为零点
        │   │               └─► emit targetReached()
        │   │
        │   └─► 否: stableCount = 0
        │           更新 lastPosition
        │
        └─► 继续下一次回调
```

---

## 5. FeedController (Fz) - 进给

### 5.1 moveToDepth() - 移动到指定深度

```
moveToDepth(double depthMm, double speed)
    │
    ├─► 深度转换为脉冲
    │   targetPulses = mmToPulses(depthMm)
    │   公式: (maxDepth - depth) * pulsesPerMm
    │
    ├─► 设置速度 (可选)
    │
    ├─► 发送绝对运动指令
    │   moveAbsolute(targetPulses)
    │
    ├─► 状态 = Moving
    │   m_isMoving = true
    │
    └─► 启动监控定时器 (100ms)
        │
        monitorTimer 回调:
        │
        ├─► 读取当前深度
        │   currentDepth()
        │
        ├─► 计算误差
        │   error = |currentPos - targetDepth|
        │
        └─► error < 0.5mm ?
            │
            ├─► 是: 到达目标!
            │       ├─► m_isMoving = false
            │       ├─► 停止定时器
            │       ├─► 状态 = Holding
            │       └─► emit targetReached()
            │
            └─► 否: 继续监控
```

**到位判断**：
- 位置误差 < 0.5mm
- 监控间隔: 100ms

---

## 6. DockingController (Dh) - 对接头

### 6.1 extend() - 伸出

```
extend()
    │
    ├─► 检查: 已伸出?
    │   └─► 是: 直接返回 true
    │
    ├─► 写入控制寄存器
    │   writeControlRegister(extendCommand=1)
    │
    ├─► 状态 = Moving
    │   目标状态 = Extended
    │
    ├─► 启动状态轮询定时器 (100ms)
    │
    └─► 启动超时定时器 (30s)
        │
        pollStatus() 定时器回调:
        │
        ├─► 读取状态寄存器
        │   readStatusRegister()
        │
        ├─► 解析状态
        │   parseStatus(statusValue)
        │
        └─► 状态 == 目标状态 (Extended)?
            │
            ├─► 是: 到位!
            │       ├─► 停止定时器
            │       ├─► 状态 = Ready
            │       └─► emit moveCompleted(true)
            │
            └─► 否: 继续轮询

        onMoveTimeout() 超时回调:
        │
        └─► 超时失败!
            ├─► 停止定时器
            ├─► setError("Move timeout")
            └─► emit moveCompleted(false)
```

**Modbus 通信**：
- 服务器地址: 192.168.1.201:502
- 控制寄存器: 0x0010
- 状态寄存器: 0x0011
- 轮询间隔: 100ms
- 超时: 30秒

---

## 7. 状态判断总结

### 堵转检测类 (力矩模式)

| 机构 | 力矩值 | 稳定阈值 | 稳定次数/时间 | 监控间隔 |
|------|--------|----------|---------------|----------|
| Cb | -50 | 1.0 | 5次 | 200ms |
| Pi | -30 | 1.0 | 3000ms | 100ms |
| Me | -50 | 1.0 | 5次 | 200ms |
| Mg | 10→80 | 1.0 | 5次 | 200ms |

### 位置到达类 (位置模式)

| 机构 | 误差阈值 | 监控间隔 | 超时 |
|------|----------|----------|------|
| Fz | 0.5mm | 100ms | 无 |
| Sr | - | - | - |
| Mr | 0.5° | - | - |

### 外部状态类 (Modbus)

| 机构 | 轮询间隔 | 超时 |
|------|----------|------|
| Dh | 100ms | 30s |

---

## 8. 完整操作流程示例

### 钻进准备流程

```
1. Fz 移动到安全位置 H (顶部)
   └─► moveToKeyPosition("H")

2. Cb 初始化并张开
   ├─► initializeClamp()  // 找零点
   └─► open()             // 张开

3. Sr 移动到目标槽位
   └─► moveToKeyPosition("A")

4. Mr 旋转到料仓位
   └─► rotateToStorage()

5. Me 伸出
   └─► extend()

6. Mg 张开
   └─► open()

7. [人工放入钻杆]

8. Mg 夹紧
   └─► close()

9. Me 收回
   └─► retract()

10. Mr 旋转到钻进位
    └─► rotateToDrill()

11. Dh 伸出对接
    └─► extend()

12. Cb 夹紧
    └─► close()

13. Pi 解锁
    └─► unlock()

14. Pr 开始旋转
    └─► startRotation()

15. Pi 开始冲击
    └─► startPercussion()

16. Fz 开始进给
    └─► setTargetDepth(targetDepth)
```

---

## 版本历史

| 日期 | 版本 | 变更 |
|------|------|------|
| 2025-01-26 | 1.0 | 初始文档 |
| 2025-01-26 | 1.1 | 添加详细操作步骤流程图 |
