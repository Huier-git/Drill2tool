# AutoTask 模块测试指南

## 一、测试模式启用/禁用

### 方法1：修改 .pro 文件（推荐）

打开 `DrillControl.pro`，找到第14行：

```qmake
# CONFIG += test_mode
```

- **启用测试**：删除注释符号 `#`，改为 `CONFIG += test_mode`
- **禁用测试**：添加注释符号，改为 `# CONFIG += test_mode`（默认）

修改后**必须重新运行 qmake 并重新编译**：

```bash
qmake DrillControl.pro
make clean
make
```

### 方法2：命令行参数

```bash
# 启用测试模式编译
qmake CONFIG+=test_mode
make

# 正常编译（禁用测试）
qmake
make
```

---

## 二、测试功能说明

启用测试模式后，AutoTaskPage 页面底部会显示橙色的测试面板：

```
┌─────────────────────────────────────┐
│ 🧪 测试功能（开发模式）              │
├─────────────────────────────────────┤
│ [ 运行单元测试 ]                     │
│ --- 模拟数据场景 ---                │
│ [ 正常钻进 ] [ 扭矩超限 ]            │
│ [ 钻压超限 ] [ 堵转 ]                │
│ [ 逐步恶化 ]                         │
│ [ 停止模拟数据 ]                     │
└─────────────────────────────────────┘
```

### 1. 运行单元测试

**功能**：验证核心计算逻辑

**测试内容**：
- ✅ 钻压公式：`P = 2*(Fu - Fl) - G`
- ✅ 扭矩限位触发（1600 Nm）
- ✅ 钻压限位触发（15000 N）
- ✅ 堵转检测（1秒窗口）
- ✅ 数据块解析
- ✅ 预设加载

**使用方法**：
1. 点击"运行单元测试"按钮
2. 查看日志输出和调试窗口（Application Output）
3. 所有测试通过会显示绿色"✅"

### 2. 模拟数据场景

**功能**：模拟传感器数据，无需连接真实硬件

#### 场景1：正常钻进
- 深度匀速增加（38 mm/min）
- 扭矩稳定在 1200 Nm
- 钻压稳定在 10000 N 左右
- **预期结果**：无故障，正常执行

#### 场景2：扭矩超限
- 前30帧正常
- 30帧后扭矩逐渐升至 1800+ Nm
- **预期结果**：SafetyWatchdog 触发 `TORQUE_LIMIT`，任务停止

#### 场景3：钻压超限
- 前20帧正常
- 20帧后钻压升至 15500+ N
- **预期结果**：SafetyWatchdog 触发 `PRESSURE_LIMIT`，任务停止

#### 场景4：堵转
- 位置几乎不变（100.00 ~ 100.09 mm）
- 速度极低（< 0.6 mm/min）
- **预期结果**：1秒后触发 `STALL_DETECTED`，任务停止

#### 场景5：逐步恶化
- 0-50帧：正常钻进
- 50-100帧：扭矩、钻压开始异常
- 100+帧：故障（扭矩 1900 Nm + 堵转）
- **预期结果**：第100帧后触发多重故障

---

## 三、测试流程推荐

### 第一步：验证计算逻辑（5分钟）

```
1. 启用测试模式，编译运行
2. 进入"自动任务"页面
3. 点击"运行单元测试"
4. 查看调试输出，确认6个测试全部通过
```

### 第二步：验证安全监控（10分钟）

```
1. 加载任务文件（config/auto_tasks/simple_test.json）
2. 点击"正常钻进"按钮 → 观察数据正常，无故障
3. 点击"停止模拟数据"
4. 点击"扭矩超限"按钮 → 30秒后应触发TORQUE_LIMIT故障
5. 重复测试其他故障场景
```

### 第三步：集成测试（可选）

```
1. 模拟正常钻进场景
2. 加载 simple_test.json
3. 点击"开始"执行任务
4. 观察步骤执行、进度更新是否正常
```

---

## 四、注意事项

### ⚠️ 发布版本必须禁用测试模式

**原因**：
- 测试代码增加 ~100KB 二进制体积
- UI 中显示测试按钮（用户体验差）
- 包含调试日志输出（性能影响）

**发布前检查清单**：
```
[ ] DrillControl.pro 中注释掉 CONFIG += test_mode
[ ] 重新 qmake && make clean && make
[ ] 运行程序，确认自动任务页面无测试面板
```

### ✅ 开发调试时启用测试模式

**优势**：
- 无需连接真实硬件
- 快速验证安全限位逻辑
- 回归测试（代码修改后防止引入Bug）
- 压力测试（长时间运行模拟数据）

---

## 五、测试文件说明

```
tests/
├── README.md                        # 测试说明
├── unit/
│   └── test_autotask.cpp           # 单元测试套件
└── mock/
    ├── MockDataGenerator.h         # 模拟数据生成器（头文件）
    └── MockDataGenerator.cpp       # 模拟数据生成器（实现）
```

**条件编译控制**：
- 所有测试代码使用 `#ifdef ENABLE_TEST_MODE` 包裹
- .pro 文件中 `CONFIG += test_mode` 会定义 `ENABLE_TEST_MODE` 宏
- 禁用测试时，这些代码完全不会编译到最终二进制文件中

---

## 六、常见问题

### Q1: 修改了 CONFIG += test_mode 后没有效果？

**A**: 必须重新运行 qmake！

```bash
qmake DrillControl.pro
make clean
make
```

### Q2: 点击"运行单元测试"后没有输出？

**A**: 单元测试输出在 Qt Creator 的"Application Output"窗口，不在UI日志中。

### Q3: 模拟数据启动后怎么停止？

**A**: 点击"停止模拟数据"按钮，或者停止整个任务。

### Q4: 能否在真实硬件上同时使用模拟数据？

**A**: 不建议。模拟数据和真实数据会混合，可能导致安全监控误判。

---

## 七、代码示例

如需在其他模块中添加测试代码，参考以下模式：

```cpp
// .h 文件
class MyClass {
#ifdef ENABLE_TEST_MODE
    void testFunction();
#endif
};

// .cpp 文件
#ifdef ENABLE_TEST_MODE
void MyClass::testFunction() {
    // 测试代码
}
#endif

// .pro 文件
test_mode {
    SOURCES += tests/my_test.cpp
}
```

---

**文档版本**: 1.0
**更新日期**: 2025-01-15
**适用版本**: DrillControl v1.x
