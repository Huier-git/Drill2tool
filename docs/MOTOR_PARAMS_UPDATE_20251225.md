# 电机参数更新记录

**日期**: 2025-12-25
**版本**: v2.2
**作者**: DrillControl开发团队

---

## 更新概述

基于实际电机型号和传动链参数，更新`config/mechanisms.json`中所有电机的换算参数。
采用**4倍频编码器模式**，确保所有脉冲计数准确。

---

## 关键修复 ⚠️

### Mr (机械手旋转) - 严重错误已修复

| 参数 | 旧值 | 新值 | 差异 | 状态 |
|------|------|------|------|------|
| `pulses_per_degree` | 144.44 | **819.20** | 467% | ❌ **必须更新** |

**影响**: 旧参数导致旋转角度严重偏差，必须立即更新！

---

## 电机参数汇总表

| 机构 | ID | 型号 | 编码器 | 减速比 | 每转脉冲 | 换算参数 | 更新状态 |
|------|----|----|-------|-------|---------|---------|---------|
| **Fz** 进给 | 2 | 647692 | 4096 | 113 | 3,702,784¹ | 12952.01 pulses/mm | ✓ 优化 |
| **Sr** 存储 | 7 | 608154 | 2048 | 26 | 212,992 | 591.64 pulses/deg | ✓ 微调 |
| **Me** 机械手伸缩 | 6 | 608154 | 2048 | 26 | 212,992 | 591.64 pulses/deg | ✓ 新增 |
| **Mg** 机械手夹紧 | 4 | 608142 | 2048 | 26 | 212,992 | 591.64 pulses/deg | ✓ 新增 |
| **Mr** 机械手旋转 | 5 | 651613 | 2048 | 36 | 294,912 | 819.20 pulses/deg | ✓ **修复** |
| **Cb** 下夹紧 | 3 | 651613 | 2048 | 36 | 294,912 | 819.20 pulses/deg | ✓ 新增 |
| **Pi** 冲击 | 1 | 647695 | 4096 | 81 | 1,327,104 | 3686.40 pulses/deg | ✓ 新增 |

¹ Fz传动链：电机 → 减速机(113:1) → 绳驱动(2:1) → 绕线轮(Ø91mm)

---

## 详细更新说明

### 1. Fz (进给机构)

**传动链**:
```
电机 → 减速机(113:1) → 绳驱动(2:1) → 绕线轮(Ø91mm) → 进给移动
```

**计算**:
```
编码器每转: 4096 × 4 = 16,384 脉冲
减速机输出: 16,384 × 113 = 1,851,392 脉冲/转
绕线轮每转: 1,851,392 × 2 = 3,702,784 脉冲
绕线轮周长: π × 91 = 285.885 mm
pulses_per_mm = 3,702,784 / 285.885 = 12,952.01
```

**更新**:
- 旧值: 13,086.9 pulses/mm
- 新值: 12,952.01 pulses/mm
- 误差: 1.04%
- 状态: ✓ 优化（误差<2%，建议更新）

---

### 2. Sr (存储机构)

**计算**:
```
输出轴每转: 2048 × 26 × 4 = 212,992 脉冲
pulses_per_degree = 212,992 / 360 = 591.64
```

**更新**:
- 旧值: 591.11 pulses/deg
- 新值: 591.64 pulses/deg
- 误差: 0.09%
- 状态: ✓ 微调（可选）

---

### 3. Me (机械手伸缩)

**计算**:
```
输出轴每转: 2048 × 26 × 4 = 212,992 脉冲
pulses_per_degree = 212,992 / 360 = 591.64
```

**更新**:
- 旧值: 无配置
- 新值: 591.64 pulses/deg
- 状态: ✓ 新增

**备注**: 虽然是位置控制模式，但补充角度换算方便后续使用

---

### 4. Mg (机械手夹紧)

**计算**:
```
输出轴每转: 2048 × 26 × 4 = 212,992 脉冲
pulses_per_degree = 212,992 / 360 = 591.64
```

**更新**:
- 旧值: 无配置（仅力矩模式）
- 新值: 591.64 pulses/deg
- 状态: ✓ 新增

**备注**: 虽然主要使用力矩控制，但补充位置换算参数，方便设定起始/结束位置

---

### 5. Mr (机械手旋转) ⚠️ 关键修复

**计算**:
```
输出轴每转: 2048 × 36 × 4 = 294,912 脉冲
pulses_per_degree = 294,912 / 360 = 819.20
```

**更新**:
- 旧值: 144.44 pulses/deg ❌ **严重错误**
- 新值: 819.20 pulses/deg ✓
- 误差: 467%
- 状态: ✓ **必须更新**

**影响分析**:
- 旧参数导致旋转角度计算错误
- 例如：旋转90度，实际只转15.87度
- 可能导致机械手位置严重偏差
- **必须在实际测试前更新！**

---

### 6. Cb (下夹紧)

**计算**:
```
输出轴每转: 2048 × 36 × 4 = 294,912 脉冲
pulses_per_degree = 294,912 / 360 = 819.20
```

**更新**:
- 旧值: 无配置（仅力矩模式）
- 新值: 819.20 pulses/deg
- 状态: ✓ 新增

---

### 7. Pi (冲击)

**计算**:
```
输出轴每转: 4096 × 81 × 4 = 1,327,104 脉冲
pulses_per_degree = 1,327,104 / 360 = 3,686.40
```

**更新**:
- 旧值: 无配置（速度模式）
- 新值: 3,686.40 pulses/deg
- 状态: ✓ 新增

---

## 新增字段说明

每个机构新增 `_motor_params` 字段，包含：

```json
"_motor_params": {
  "model": "电机型号",
  "encoder_resolution": "编码器精度（线/转）",
  "reduction_ratio": "减速比",
  "quadrature_mode": 4,
  "pulses_per_motor_rev": "电机转一圈的编码器脉冲数（4倍频）",
  "pulses_per_output_rev": "输出轴转一圈的脉冲数",
  "rated_torque_mNm": "额定转矩（mN·m）"
}
```

**用途**:
1. 文档记录，便于后续维护
2. 验证换算参数的正确性
3. 调试时快速查找电机规格

---

## 测试验证

### 必须测试的项目

1. **Mr (机械手旋转)** - 最高优先级
   - [ ] 旋转90度，验证实际角度是否为90度
   - [ ] 旋转180度，验证实际角度是否为180度
   - [ ] 验证key_positions的脉冲值是否需要调整

2. **Fz (进给)**
   - [ ] 移动100mm，验证实际距离是否为100mm
   - [ ] 验证H/K/A位置的mm值是否正确

3. **其他新增参数的机构**
   - [ ] 验证位置显示是否合理
   - [ ] 验证运动控制是否正常

### 验证方法

**方法1: ControlPage表格验证**
1. 切换到物理单位模式
2. 查看各电机的MPos显示值
3. 手动移动已知距离/角度
4. 验证显示值与实际值是否一致

**方法2: 机构控制器验证**
1. 使用DrillControlPage的各机构控制器
2. 移动到预设位置
3. 用测量工具验证实际位置

---

## 配置文件版本

**文件**: `config/mechanisms.json`
- 旧版本: v2.1
- 新版本: v2.2
- 更新日期: 2025-12-25

---

## 风险提示 ⚠️

### 高风险

1. **Mr (机械手旋转)**: 参数变化467%，运动行为完全不同
   - 首次测试时使用**极小的移动量**（如5度）
   - 确认运动方向和幅度正确后再增大
   - 注意碰撞风险

### 中风险

2. **Fz (进给)**: 参数变化1.04%，影响较小但需验证
   - 验证A/H/K位置的实际mm值
   - 确认不会越界（max=1001mm）

### 低风险

3. **新增参数的机构**: 之前未使用这些换算，风险较低
   - 主要用于显示和调试
   - 不影响现有控制逻辑

---

## 回滚方案

如果新参数导致问题，可以回滚到旧版本：

**快速回滚**:
```bash
git checkout HEAD~1 config/mechanisms.json
```

**手动回滚（关键参数）**:
```json
"Mr": {
  "pulses_per_degree": 144.44,  // 回滚到旧值（错误值）
}

"Fz": {
  "pulses_per_mm": 13086.9,      // 回滚到旧值
}
```

**注意**: 不推荐回滚Mr，因为旧值是错误的！

---

## 版本历史

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|---------|
| v2.2 | 2025-12-25 | DrillControl团队 | 更新所有电机参数，修复Mr严重错误 |
| v2.1 | 2025-01-26 | DrillControl团队 | 初始版本 |

---

## 相关文档

- `config/mechanisms.json` - 机构参数配置文件（已更新）
- `docs/CONTROLPAGE_COORDINATE_SYSTEM.md` - 坐标系统详解
- `docs/MECHANISM_CONTROLLERS_GUIDE.md` - 机构控制器指南
- `docs/FEED_COORDINATE_SYSTEM_MIGRATION.md` - 进给坐标系迁移
