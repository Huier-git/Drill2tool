# 测试问题修复说明

## 修复内容

### 1. 单元测试崩溃问题 ✅

**问题原因**：
- `DrillParameterPreset::isValid()` 需要以下字段才能返回 true：
  ```cpp
  !id.trimmed().isEmpty()
  && feedSpeedMmPerMin > 0.0
  && rotationRpm > 0.0
  ```
- 原测试代码只设置了 `id`、`torqueLimitNm`、`pressureLimitN`
- 导致 `watchdog.arm(preset)` 失败（`m_armed = false`）
- `onTelemetryUpdate()` 直接返回，故障不会触发
- `Q_ASSERT(faultTriggered)` 失败，程序终止

**修复方式**：
在所有测试中添加必需字段：
```cpp
DrillParameterPreset preset;
preset.id = "TEST";
preset.feedSpeedMmPerMin = 38.0;  // ← 新增
preset.rotationRpm = 55.0;        // ← 新增
preset.torqueLimitNm = 1600.0;
preset.pressureLimitN = 15000.0;
```

**修复文件**：
- `tests/unit/test_autotask.cpp` (第 43-127 行)

---

### 2. 发行模式 UI 清理 ✅

**确保机制**：
所有测试相关代码都被 `#ifdef ENABLE_TEST_MODE` 包裹：

```cpp
// AutoTaskPage.h
#ifdef ENABLE_TEST_MODE
    MockDataGenerator* m_mockGenerator;
    void setupTestUI();
    // ... 测试槽函数
#endif

// AutoTaskPage.cpp
#ifdef ENABLE_TEST_MODE
    #include "MockDataGenerator.h"
    // ... 测试相关头文件
#endif

// 构造函数
#ifdef ENABLE_TEST_MODE
    setupTestUI();
#endif
```

**验证方式**：
```bash
cd D:\KT_DrillControl
qmake DrillControl.pro
# 输出：Project MESSAGE: 测试模式已禁用 - 正常编译
```

此时编译的程序：
- ✅ 不包含任何测试代码
- ✅ AutoTaskPage 中无测试面板
- ✅ 二进制文件体积减小约 100KB

---

### 3. MockDataGenerator 连接修复 ✅

**问题**：
`setupTestUI()` 在构造函数中调用，但此时 `m_drillManager` 还未创建（在 `setControllers()` 中创建）

**修复方式**：
在 `setControllers()` 中添加补充连接：
```cpp
#ifdef ENABLE_TEST_MODE
    if (m_mockGenerator) {
        connect(m_mockGenerator, &MockDataGenerator::dataBlockReady,
                m_drillManager, &AutoDrillManager::onDataBlockReceived,
                Qt::UniqueConnection);  // 防止重复连接
    }
#endif
```

---

## 使用说明

### 启用测试模式（开发/调试）

1. 打开 `DrillControl.pro`，第14行改为：
   ```qmake
   CONFIG += test_mode
   ```

2. 重新编译：
   ```bash
   qmake DrillControl.pro
   make clean
   make
   ```

3. 运行程序，自动任务页面底部会显示测试面板

### 禁用测试模式（发布/生产）

1. 打开 `DrillControl.pro`，第14行改为：
   ```qmake
   # CONFIG += test_mode
   ```

2. 重新编译：
   ```bash
   qmake DrillControl.pro
   make clean
   make
   ```

3. 运行程序，**自动任务页面完全没有测试相关内容**

---

## 测试验证

### 单元测试（启用测试模式后）

1. 进入"自动任务"页面
2. 点击"运行单元测试"按钮
3. 查看调试输出窗口（Qt Creator 的 Application Output）
4. 应看到：
   ```
   ╔═══════════════════════════════════════╗
   ║   AutoTask 模块单元测试套件          ║
   ╚═══════════════════════════════════════╝

   === Test 1: 钻压计算公式 ===
   ✅ 钻压计算正确

   === Test 2: 扭矩限位触发 ===
   ✅ 扭矩超限正确触发故障

   === Test 3: 钻压限位触发 ===
   ✅ 钻压超限正确触发故障

   === Test 4: 堵转检测 ===
   ✅ 堵转检测正确触发

   === Test 5: 数据块解析 ===
   ✅ 数据块结构正确

   === Test 6: 预设加载 ===
   ✅ 预设加载正确

   ╔═══════════════════════════════════════╗
   ║   ✅ 所有测试通过                     ║
   ╚═══════════════════════════════════════╝
   ```

### 发行版验证

1. 禁用测试模式
2. 重新编译
3. 运行程序
4. 检查"自动任务"页面 → **应该没有橙色测试面板**

---

## 注意事项

⚠️ **Q_ASSERT 会在 Debug 模式下终止程序**
- 这是正常行为（用于开发时快速发现错误）
- Release 模式下 Q_ASSERT 会被优化掉，不会崩溃

⚠️ **发布前必须检查**
```bash
[ ] DrillControl.pro 中测试模式已注释
[ ] 重新 qmake && make clean && make
[ ] 运行确认无测试 UI
```

---

**修复完成日期**: 2025-01-15
**涉及文件**:
- `tests/unit/test_autotask.cpp`
- `src/ui/AutoTaskPage.cpp`
- `DrillControl.pro` (已禁用测试模式)
