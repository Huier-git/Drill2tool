# DatabasePage 数据库查询可视化使用指南

## 概述

DatabasePage 是 KT_DrillControl 系统的数据回放与分析模块，提供直观的数据库查询、时序曲线可视化和数据导出功能。适用于查看历史钻进数据、分析 AutoTask 执行细节、以及导出数据进行深度分析。

---

## 界面布局

### 整体结构

```
┌─────────────────────────────────────────────────────────────┐
│ 数据库查询 (DatabasePage)                                    │
├──────────────┬──────────────────────────────────────────────┤
│  左侧控制面板  │           右侧数据展示区                      │
│  (300-500px) │                                              │
│              │  ┌──────────────────────────────────────┐    │
│ ┌──────────┐ │  │  趋势曲线 (图表区域)                  │    │
│ │轮次列表   │ │  │  - 标量数据图 (MDB+电机)             │    │
│ │          │ │  │  - 振动RMS包络图 (X/Y/Z)             │    │
│ └──────────┘ │  └──────────────────────────────────────┘    │
│              │  ↕ 可拖动分隔条                               │
│ ┌──────────┐ │  ┌──────────────────────────────────────┐    │
│ │查询控制   │ │  │  数据详情 (表格区域)                  │    │
│ │- 时间预览 │ │  │  每行 = 1秒时间窗口                   │    │
│ │- 时间范围 │ │  │  显示各传感器采样点数                 │    │
│ │- 快捷选择 │ │  └──────────────────────────────────────┘    │
│ │- 查询按钮 │ │                                              │
│ │- 导出按钮 │ │                                              │
│ └──────────┘ │                                              │
│              │                                              │
│ ┌──────────┐ │                                              │
│ │高级SQL   │ │                                              │
│ │(可折叠)   │ │                                              │
│ └──────────┘ │                                              │
└──────────────┴──────────────────────────────────────────────┘
```

### 设计特点

- **左右分栏**：左侧控制，右侧展示，符合操作流程
- **上下分栏**：图表与表格同时可见，无需切换Tab
- **自适应布局**：拖动分隔条调整各区域大小
- **亮色主题**：清晰易读，适合长时间数据分析

---

## 基础操作流程

### 1. 选择实验轮次

#### 步骤：
1. 点击**"刷新列表"**按钮更新轮次列表
2. 在轮次列表中单击选中一个轮次
3. 双击轮次行 **或** 点击**"选择此轮次"**按钮

#### 轮次信息显示：
- **ID**：轮次编号
- **开始时间**：实验开始的日期时间 (格式: `MM-dd HH:mm:ss`)
- **时长**：实验持续时间 (自动格式化为 秒/分/小时)
- **状态**：轮次状态标识

#### 提示：
- 轮次按开始时间倒序排列（最新在最上）
- 选中轮次后，右上角显示轮次信息：`轮次 X | 总时长: Y 秒`

---

### 2. 选择时间范围

选中轮次后，有**三种方式**选择查询的时间范围：

#### 方式一：迷你趋势图（推荐）
- **位置**：查询控制区域顶部的 80px 高度预览图
- **功能**：显示整个轮次的缩略趋势曲线
- **操作**：点击图表上的任意位置，自动选择 **该时间点 ±5 秒** 的范围

**使用场景**：快速定位感兴趣的时间段

#### 方式二：SpinBox 数值输入
- **起始(s)**：输入起始秒数
- **结束(s)**：输入结束秒数
- 自动校验：结束时间不能小于起始时间

**使用场景**：精确指定查询范围

#### 方式三：快捷选择按钮
- **全部**：选择整个轮次 (0 ~ 总时长)
- **前10秒**：选择开始的前 10 秒 (0 ~ 10)
- **后10秒**：选择结束的后 10 秒 (总时长-10 ~ 总时长)

**使用场景**：快速选择常用范围

---

### 3. 查询数据

#### 操作：
点击蓝色**"查询数据"**按钮

#### 查询过程：
1. 按钮变为**"查询中..."**并禁用（防止重复点击）
2. 后台异步查询数据库（不阻塞UI）
3. 查询完成后自动更新图表和表格

#### 查询结果：

**表格显示**（数据详情区域）：
- 每行代表 1 秒时间窗口
- 列内容：
  - **时间(秒)**：相对于轮次开始的秒数
  - **振动X/Y/Z**：各通道的采样点数
  - **MDB**：MDB传感器数据点数（扭矩、拉力、位置等）
  - **电机**：电机参数数据点数（位置、速度、扭矩、电流）

**图表显示**（趋势曲线区域）：
- **上方图表**：标量数据时序曲线（MDB传感器 + 电机参数）
  - 多条曲线，颜色区分不同传感器
  - 支持鼠标拖动平移、滚轮缩放
- **下方图表**：振动RMS包络曲线（X/Y/Z三轴）
  - 红色 = X轴，绿色 = Y轴，蓝色 = Z轴
  - 显示每秒的RMS值（有效值），非原始5kHz数据

---

### 4. 交互式数据探索

#### 功能一：图表 → 表格 同步

**操作**：点击任意图表上的任意位置

**效果**：
1. 表格自动滚动到最接近该时间点的行
2. 该行高亮显示
3. 图表上显示橙色虚线游标标识当前位置

**使用场景**：在图表中发现异常波动，快速定位到对应时间的详细数据

#### 功能二：表格 → 图表 同步

**操作**：在表格中点击选择任意行

**效果**：
1. 图表上显示橙色虚线游标，标识该行对应的时间点
2. 游标位置 = 该行的时间值

**使用场景**：浏览表格时，同时在图表中查看该时间点在曲线上的位置

#### 功能三：双图表 X 轴联动

**操作**：在任一图表上拖动或缩放

**效果**：
- 两个图表的X轴（时间轴）自动同步
- 可同时对比不同类型数据在同一时间段的变化

**使用场景**：对比扭矩曲线与振动曲线的相关性

---

### 5. 导出数据

#### 操作：
1. 完成查询后，点击蓝色**"导出数据"**按钮
2. 选择保存路径和文件名（默认格式：`round_X_Ys-Zs.csv`）
3. 点击保存

#### 导出过程：
- 显示进度对话框
- 后台异步导出（不阻塞UI）
- 可随时点击"取消"中止导出

#### 导出格式（CSV）：

```csv
# Round ID: 1
# Time Range: 10.0 - 20.0 seconds
# Export Time: 2025-01-18 16:30:00
timestamp_us,sensor_type,value
1700000000000,100,125.5
1700000000000,100,126.2
1700000000000,300,1500.3
...
```

**字段说明**：
- `timestamp_us`：微秒时间戳（绝对时间）
- `sensor_type`：传感器类型编号（见附录）
- `value`：传感器数值

**导出范围**：仅导出当前查询的时间范围内的标量数据（不含原始振动波形）

---

## 高级功能

### SQL 交互模式

**位置**：左侧面板最下方的"高级 SQL 交互" GroupBox（默认折叠）

#### 开启方式：
点击 GroupBox 标题栏的复选框展开

#### 功能：
- 直接执行自定义 SQL 查询语句
- 结果显示在右侧表格中（替换当前显示）
- 限制最多显示 1000 行（防止UI卡死）

#### 使用示例：

**查询某轮次的所有扭矩数据：**
```sql
SELECT timestamp_us, value
FROM scalar_data
WHERE round_id = 1 AND sensor_type = 100
ORDER BY timestamp_us
```

**查询振动RMS统计信息：**
```sql
SELECT timestamp_us, channel, rms_value, peak_value
FROM vibration_stats
WHERE round_id = 1 AND channel = 0
```

**注意事项**：
- 仅支持 **SELECT** 查询（只读）
- 不支持 INSERT/UPDATE/DELETE（安全限制）
- 复杂查询可能耗时较长，建议加 `LIMIT` 限制行数

---

## 数据类型说明

### 传感器类型编号（sensor_type）

| 编号范围 | 类型 | 具体传感器 |
|---------|------|-----------|
| 0-2 | 振动数据 | 通道 0/1/2 (X/Y/Z轴) |
| 100-199 | MDB传感器 | 扭矩(100)、上拉力(101)、下拉力(102)、位置(103) |
| 300-399 | 电机参数 | 位置(300)、速度(301)、扭矩(302)、电流(303) |

### 数据存储结构

- **scalar_data 表**：标量数据（MDB + 电机），每秒多个采样点
- **vibration_data 表**：振动原始波形（5kHz采样，BLOB存储）
- **vibration_stats 表**：振动统计值（RMS/峰值/均值，每秒1个）
- **rounds 表**：实验轮次元数据

---

## 使用场景示例

### 场景一：查看 AutoTask 执行过程

**目标**：回放某次自动钻进任务的完整过程

**步骤**：
1. 在轮次列表中找到备注包含 `AutoTask:xxx.json` 的轮次
2. 双击选中该轮次
3. 点击**"全部"**快捷按钮选择整个过程
4. 点击**"查询数据"**
5. 在图表中查看扭矩、位置、振动的时序变化

**分析要点**：
- 扭矩曲线是否平稳
- 位置曲线是否匀速增长
- 振动RMS是否有异常突增

---

### 场景二：定位异常事件

**目标**：找到某次钻进中扭矩突然升高的时间点

**步骤**：
1. 选中问题轮次
2. 查询整个轮次数据
3. 在标量图表中找到扭矩曲线的峰值位置
4. **点击峰值位置**
5. 表格自动滚动到该时间点，查看同一时刻其他传感器数据

**分析要点**：
- 该时刻的钻压是否过大
- 振动RMS是否同步升高
- 电机速度是否下降（堵转迹象）

---

### 场景三：导出数据进行离线分析

**目标**：使用 Python/MATLAB 进行深度数据处理

**步骤**：
1. 选中轮次和感兴趣的时间段
2. 点击**"导出数据"**保存为 CSV
3. 使用外部工具加载数据：

**Python 示例**：
```python
import pandas as pd

# 读取导出的CSV
df = pd.read_csv('round_1_0s-100s.csv', comment='#')

# 筛选扭矩数据
torque = df[df['sensor_type'] == 100]

# 绘制时序图
import matplotlib.pyplot as plt
plt.plot(torque['timestamp_us'], torque['value'])
plt.xlabel('Time (us)')
plt.ylabel('Torque')
plt.show()
```

---

## 性能提示

### 查询优化

- **小范围查询**：10-30秒范围响应最快（<1秒）
- **中等范围**：30-120秒可能需要 2-5秒
- **大范围查询**：>300秒建议分段查询或使用SQL模式

### 界面响应

- **异步查询**：查询期间UI不会卡死，可继续操作其他功能
- **进度反馈**：查询按钮变为"查询中..."，完成后自动恢复
- **取消查询**：再次点击"查询数据"可取消正在运行的查询

### 图表性能

- **缩放流畅**：图表支持硬件加速渲染
- **数据点限制**：单次查询建议不超过 10000 个数据点
- **刷新优化**：图表仅在数据变化时重绘

---

## 常见问题

### Q1: 为什么查询结果为空？

**可能原因**：
1. 选中的轮次没有数据（采集未启动）
2. 选择的时间范围超出轮次实际时长
3. 数据库文件损坏或路径错误

**解决方法**：
- 检查轮次列表中的"时长"列是否为 0
- 点击"全部"按钮重新选择完整范围
- 查看控制台是否有数据库错误日志

### Q2: 图表上看不到游标线？

**原因**：游标线仅在时间点位于图表可见范围内时显示

**解决方法**：
- 在表格中选择其他行（时间点在可见范围内）
- 或拖动图表使该时间点进入可见区域

### Q3: 导出数据时提示"无法创建文件"？

**原因**：
- 目标路径无写入权限
- 磁盘空间不足
- 文件名包含非法字符

**解决方法**：
- 更换保存路径（如桌面）
- 清理磁盘空间
- 使用英文文件名

### Q4: 振动图表显示与标量图表不同步？

**原因**：振动RMS统计值可能存在采样时间偏差

**说明**：这是正常现象，因为振动数据的统计计算基于1秒窗口，与标量数据的瞬时采样不完全对齐

---

## 快捷键（未来支持）

| 快捷键 | 功能 |
|-------|------|
| Ctrl+R | 刷新轮次列表 |
| Ctrl+Q | 执行查询 |
| Ctrl+E | 导出数据 |
| Ctrl+A | 选择全部时间范围 |

---

## 技术架构

### 数据流

```
SQLite数据库
    ↓
DataQuerier (查询器)
    ↓
异步查询 (QtConcurrent)
    ↓
DatabasePage UI (展示)
    ├─ QCustomPlot (图表)
    └─ QTableWidget (表格)
```

### 关键组件

- **DataQuerier**：数据库查询封装类，提供轮次查询、时间范围查询、振动统计查询等接口
- **QCustomPlot**：第三方图表库，支持高性能时序曲线绘制
- **QtConcurrent**：Qt并发框架，用于异步查询避免UI阻塞
- **QSplitter**：可拖动分隔条，实现自适应布局

---

## 版本历史

### v2.0 (2025-01-18)
- 🎨 UI重构：TabWidget → QSplitter 双面板布局
- ✨ 新增迷你趋势图时间选择器
- ✨ 新增图表-表格双向同步交互
- ✨ 新增双图表X轴联动
- 🎨 主题切换：深色 → 亮色（可定制）
- ⚡ 性能优化：异步查询 + 采样显示

### v1.0 (2025-01-17)
- 基础查询功能
- TabWidget布局
- CSV导出
- SQL交互模式

---

## 反馈与支持

如有问题或建议，请联系开发团队或在项目仓库提交 Issue。

**项目文档**：`D:\KT_DrillControl\docs\`
**数据库位置**：`D:\KT_DrillControl\database\drill_data.db`
