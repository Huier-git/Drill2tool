# DrillControl 现场测试计划

## 1. 目标与范围
- 覆盖 9 个自由度机构（Fz/Pr/Pi/Cb/Sr/Me/Mg/Mr/Dh）的单体、联动及异常恢复能力。
- 验证振动 (VK701)、Modbus 传感器、电机参数三个采集线程与数据库写入的一致性。
- 现场复核 MotionLockManager、急停链路、ZMotion 单句柄互斥的安全策略，确保实机动作在最坏情况下可受控停止。

## 2. 角色与沟通
| 角色 | 职责 | 现场联系人 |
| --- | --- | --- |
| 软件负责人 | 部署 Qt 上位机、收集日志、调整配置 | |
| 下位机工程师 | 烧录/运行 `ZmotionCode/Zbasic_/ECAT_Scan.bas`，观察驱动、轴映射 | |
| 硬件与液压负责人 | 检查夹持、油路、气路、润滑状态 | |
| 安全员/指挥 | 执行停机/解锁指令，记录风险 | |

## 3. 现场前检查清单
### 3.1 硬件
- [ ] 主/副电源 (380V、220V、24V)、UPS、柜内风扇已上电并稳定。
- [ ] EtherCAT 链路、RJ45、Modbus TCP 交换机灯状态正常，无松脱。
- [ ] 伺服驱动器面板无告警，液压/气源压力达到工艺要求。
- [ ] 钻具、卡瓦、操控手臂、料仓轨迹范围清理完毕，行程标尺清楚。
- [ ] 传感器 (加速度、力矩、位移) 线缆固定，通道编号与 `config/mechanisms.json` 对齐。
- [ ] 三处急停、护罩门磁、声光报警器已实测。

### 3.2 软件/数据
- [ ] 使用 `release/` 或 `build/debug/DrillControl.exe` 最新编译产物，版本号记录在测试表。
- [ ] `config/mechanisms.json` 与现场电机/减速比/关键位置一致，并完成热更新校验。
- [ ] `docs/CONTROL_SYSTEM_ARCHITECTURE.md`、`docs/MECHANISM_CONTROLLERS_GUIDE.md` 已复核，相关操作手册到手。
- [ ] `ZmotionCode/Zbasic_/ECAT_Scan.bas` 已根据现场节点调整（映射、PDO、脉冲数）。
- [ ] `debug/`、`logs/` 目录清空或备份，准备采集本次记录。

### 3.3 安全门槛
- [ ] 急停链路每班前执行一次，确认所有轴可瞬时掉使能。
- [ ] MotionLockManager 状态页（DrillControlPage → 状态栏）应显示 "Idle"，否则先清锁。
- [ ] 操作员明确"动作许可"口令，确认后方可执行运动。
- [ ] 周边安全距离贴上警示条，限定观察点。

## 4. 推荐执行顺序
| 序号 | 测试块 | 目标 | 输出 |
| --- | --- | --- | --- |
| 1 | 上电与通信 | 确认网络、驱动、ZMotion 控制器在线 | `?Map` 截图、驱动面板照 |
| 2 | EtherCAT 扫描 | `ECAT_Scan.bas` 成功映射节点、清告警 | 记录每轴别名/厂商 |
| 3 | 低能机构 (Cb/Sr/Dh) | 验证夹持、料仓、对接动作 | 视频 + 位置/压力数据 |
| 4 | 机械手 (Me/Mg/Mr) | 验证取料、夹取、回转极限 | 机械手轨迹、力矩曲线 |
| 5 | 主运动 (Fz/Pr/Pi) | 验证进给、旋转、冲击性能与互锁 | 速度/力矩/振动数据 |
| 6 | 数据采集 | 比对三线程数据时间戳、刷新率 | 原始 CSV/数据库条目 |
| 7 | 安全/互锁 | MotionLock 冲突、急停、掉电恢复 | 事件日志、操作记录 |
| 8 | 集成流程 | 模拟完整钻进/换杆/异常恢复 | 作业记录单、关键帧 |
| 9 | 数据归档 | 导出 SQLite/日志、整理测试单 | 数据包 + 结论 |

## 5. 机制级验证
### 5.1 Cb (Clamp)
- **准备**：装夹区无钻杆，压力表正常；ControlPage 中 Cb 轴处于扭矩模式。
- **步骤**：执行开/合动作各 3 次，逐步升扭矩；观察 `MotorPage` 中 DAC、Torque。
- **通过标准**：闭合保持扭矩 < 80% 设定上限，动作时间 < 1.5s，无超调报警。
- **记录**：扭矩曲线、夹口间隙测量、日志时间戳。

### 5.2 Sr (Storage)
- **准备**：确认轨道无异物，位置标尺清晰。
- **步骤**：在 DrillControlPage 选择 3 个关键位置（A/M/Z），执行往返并记录编码器值。
- **通过标准**：位置误差 < ±0.5mm，减速/停止段无抖动。
- **记录**：位置-时间曲线、`debug/` 日志片段。

### 5.3 Dh (Docking)
- **准备**：Modbus 客户端监视相关寄存器，确保网络延迟 < 10ms。
- **步骤**：执行伸出/回收、半行程悬停，观察压力与电流。
- **通过标准**：位置差 < 1mm，Modbus 状态寄存器无异常码。
- **记录**：寄存器抓包、视频。

### 5.4 Me (Arm Extension)
- **准备**：确认臂前方无遮挡。
- **步骤**：执行全行程伸缩，验证软限位、关键点 (A/H)。
- **通过标准**：编码器误差 < 0.3%，速度曲线平滑。
- **记录**：关键位置编码器值。

### 5.5 Mg (Arm Grip)
- **准备**：准备测试件，设置 3 档夹持力。
- **步骤**：执行轻/中/重夹取，确认力矩闭环及松开动作。
- **通过标准**：夹持力重复性 < ±5%，无超压告警。
- **记录**：力矩、夹爪位移曲线。

### 5.6 Mr (Arm Rotation)
- **准备**：确认旋转范围 0–360° 无障碍。
- **步骤**：执行 ±90°、±180° 定点旋转，检查回零。
- **通过标准**：角度误差 < 0.5°，停止段无振荡。
- **记录**：角度-时间曲线。

### 5.7 Fz (Feed)
- **准备**：钻杆悬空，设置安全限位。
- **步骤**：执行 3 段速度 (低/中/高) 的匀速进给与 2 次快速回退。
- **通过标准**：位置误差 < ±1mm，速度误差 < ±5%，遇急停可在 150mm 内停止。
- **记录**：位置、速度、力矩、急停响应时间。

### 5.8 Pr (Rotation)
- **准备**：开环检查润滑，确认扭矩传感器已校准。
- **步骤**：执行 3 档转速 (空载)、1 次加载扭矩 (模拟阻力)。
- **通过标准**：转速稳定性 ±3%，扭矩闭环响应 < 200ms。
- **记录**：转速、扭矩、振动 RMS。

### 5.9 Pi (Percussion)
- **准备**：气动/液压供给稳定。
- **步骤**：执行不同频率/能级的冲击，监控加速度曲线。
- **通过标准**：频率误差 < ±2Hz，冲击后无残余堵塞。
- **记录**：频谱、峰值加速度、驱动温度。

## 6. 数据采集验证
- **VK701 (VibrationThread)**：在 `VibrationPage` 启动采集，记录 3 组 5s 波形，对比 VK701 工具抓到的频谱；校验采样率 5kHz±1%。
- **Modbus 传感器 (MdbThread)**：使用抓包工具对比 UI 显示值与真实寄存器；验证断线重连（拔掉/恢复网络）。
- **MotorThread**：在空跑与运动阶段抓取 EN/MPos/MVel，检查刷新周期间隔 100ms±10ms，并确认与 `ControlPage` 表格一致。
- **数据库写入**：触发动作 10 次后，核对 SQLite 表条目、时间戳排序，与日志中 `DbWriter` 输出一致。

## 7. 安全与互锁
1. **MotionLock 冲突**：在 DrillControlPage 启动自动脚本，再尝试手动轴移动，确认弹出冲突提示并可安全抢占。
2. **急停链路**：在 Fz 进给 30% 额定速度时触发急停，检测停止距离、日志是否记录 `emergencyStop()` 调用。
3. **掉电/复位**：模拟 ZMotion 控制器断电，确认 UI 报错、重新上电后的 `ECAT_Scan.bas` 可重跑，状态恢复为 Idle。
4. **软限位**：在各轴靠近极限时验证 MotionLockManager 是否拒绝危险命令。

## 8. 集成场景
- **干跑钻进循环**：按照 "夹紧 → 起升 → 旋转/冲击 → 送杆 → 松夹 → 取料" 完成一次完整循环，记录时间轴。
- **自动脚本 + 手动介入**：在自动模式执行中插入手动姿态修正，验证互锁释放流程。
- **异常恢复**：故意制造 Modbus 丢包、传感器超限，验证 UI 报警、切到安全状态、再次恢复。

## 9. 故障排查
1. 查看 `debug/` 和 `logs/*`，定位 `ECAT_InitEnable`、采集线程断言。
2. 使用 ControlPage 命令终端运行 `?Map`、`GetErr`，确认轴映射/故障码。
3. 若 MotionLock 卡死，使用 `MotionLockManager::emergencyStop()`（UI 急停按钮）清除后再操作。
4. 记录硬件状态（驱动灯、压力表）并与软件日志对照，确保问题闭环。

## 10. 数据记录模板
| 日期 | 测试块 | 机构/线程 | 工况描述 | 结果 (Pass/Fail) | 关键数据文件 | 备注 |
| --- | --- | --- | --- | --- | --- | --- |
| 2025- | | | | | | |
