# 关键位置配置说明

## 概述

关键位置（Key Positions）是各机构在自动化流程中使用的标准位置点，用字母 A-J 标识。这些位置在 `config/mechanisms.json` 中配置，并可通过 DrillControlPage 的"参数配置"Tab进行编辑。

## 当前使用情况

### Controller中的使用
目前各Controller使用的是**简化的位置参数**：
- `safePosition` - 安全位置（通常对应关键位置A或某个默认安全点）
- `workPosition` - 工作位置（通常对应关键位置B或主工作点）

例如：
```cpp
// ArmExtensionController
config.extendPosition = workPosition;  // 伸出位置
config.retractPosition = safePosition; // 收回位置

// ArmRotationController
config.drillPositionAngle = workPosition;    // 钻进位置角度
config.storagePositionAngle = safePosition;  // 存储位置角度
```

### 关键位置的实际用途
1. **UI手动控制**：为操作员提供标准位置的快捷访问
2. **自动化序列**：未来的自动钻进流程将使用这些标准位置
3. **参数记录**：方便记录、查询和调整各个标准位置
4. **调试和标定**：在系统调试时提供位置参考

## 各机构关键位置定义

### Fz - 进给机构（10个位置）
| 代号 | 说明 | 用途 |
|------|------|------|
| A | 最底端 | 进给机构的最低位置 |
| B | 钻管底端对接结束 | 钻管底部连接完成位置 |
| C | 钻管底端对接开始 | 钻管底部开始连接位置 |
| D | 钻管顶端对接结束 | 钻管顶部连接完成位置 |
| E | 钻具顶端对接结束 | 钻具顶部连接完成位置 |
| F | 钻管顶端对接开始 | 钻管顶部开始连接位置 |
| G | 钻具顶端对接开始 | 钻具顶部开始连接位置 |
| H | 最顶端 | 进给机构的最高位置 |
| I | 搭载钻管后底部对接结束 | 带钻管时的底部对接位置 |
| J | 搭载钻管后顶部对接开始 | 带钻管时的顶部对接位置 |

**单位**：脉冲（通过 `pulses_per_mm` 转换为mm）

### Sr - 存储机构（7个位置）
| 代号 | 说明 | 用途 |
|------|------|------|
| A | 位置0 | 第1个钻杆存储位 |
| B | 位置1 | 第2个钻杆存储位 |
| C | 位置2 | 第3个钻杆存储位 |
| D | 位置3 | 第4个钻杆存储位 |
| E | 位置4 | 第5个钻杆存储位 |
| F | 位置5 | 第6个钻杆存储位 |
| G | 位置6 | 第7个钻杆存储位 |

**单位**：脉冲（每个位置间隔 51.43° ≈ 30400脉冲）

### Me - 机械手伸缩（3个位置）
| 代号 | 说明 | 用途 |
|------|------|------|
| A | 完全收回 | 机械手完全收回的安全位置 |
| B | 面对存储机构 | 对准存储机构取钻杆的位置 |
| C | 面对对接头 | 对准对接头安装钻杆的位置 |

**单位**：脉冲

### Mg - 机械手夹紧（2个位置）
| 代号 | 说明 | 用途 |
|------|------|------|
| A | 完全张开 | 夹爪完全打开，可以接收钻杆 |
| B | 完全夹紧 | 夹爪完全夹紧，固定钻杆 |

**单位**：DAC（力矩控制值）

### Mr - 机械手回转（2个位置）
| 代号 | 说明 | 用途 |
|------|------|------|
| A | 对准存储机构 | 机械手朝向存储机构 |
| B | 对准对接头 | 机械手朝向钻机对接头 |

**单位**：脉冲（通过 `pulses_per_degree` 转换为角度）

### Dh - 对接推杆（2个位置）
| 代号 | 说明 | 用途 |
|------|------|------|
| A | 完全推出 | 推杆伸出，推动钻杆进入卡盘 |
| B | 完全收回 | 推杆收回，等待下一根钻杆 |

**单位**：脉冲（Modbus控制）

### Pr - 回转（4个状态）
| 代号 | 说明 | 用途 |
|------|------|------|
| A | 不旋转 | 停止状态 |
| B | 正向对接速度 | 正转用于连接钻杆 |
| C | 逆向对接速度 | 反转用于拆卸钻杆 |
| D | 程序调控速度 | 钻进时的工作转速 |

**单位**：RPM（转速）

### Pi - 冲击（2个状态）
| 代号 | 说明 | 用途 |
|------|------|------|
| A | 不冲击 | 停止状态 |
| B | 程序调控冲击 | 钻进时的工作频率 |

**单位**：Hz（频率）

### Cb - 下夹紧（2个位置）
| 代号 | 说明 | 用途 |
|------|------|------|
| A | 完全张开 | 卡盘打开，释放钻杆 |
| B | 完全夹紧 | 卡盘夹紧，固定钻杆 |

**单位**：DAC（力矩控制值）

## 配置文件格式

```json
{
  "mechanisms": {
    "Fz": {
      "name": "进给机构",
      "motor_id": 2,
      "pulses_per_mm": 13086.9,
      "key_positions": {
        "A": 0,
        "B": 1000000,
        "C": 1500000,
        ...
      }
    }
  }
}
```

## 如何编辑关键位置

1. 启动程序，打开 DrillControlPage
2. 切换到"参数配置"Tab
3. 在"选择机构"下拉框中选择要编辑的机构
4. 滚动到"关键位置 (A-J)"表格
5. 编辑"值 (脉冲)"列中的数值
6. 点击"应用到当前机构"预览更改
7. 点击"保存到配置文件"永久保存

## 注意事项

1. **单位换算**：
   - 位置类机构（Fz/Sr/Me/Mr）：脉冲值，通过 pulses_per_mm 或 pulses_per_degree 换算
   - 力矩类机构（Mg/Cb）：DAC值（-10000 ~ 10000）
   - 速度类机构（Pr/Pi）：RPM或Hz

2. **安全限位**：
   - 修改位置时确保在 `min_position` 和 `max_position` 范围内
   - 避免设置可能导致机械碰撞的位置

3. **标定流程**：
   - 修改关键位置后建议进行手动测试
   - 确认各位置能正常到达且不干涉其他机构
   - 记录实际测量值以便后续微调

4. **备份配置**：
   - 修改前备份 `config/mechanisms.json`
   - 重要参数变更后创建版本记录

## 未来扩展

关键位置系统将支持：
- 自动钻杆更换流程
- 钻进深度分段控制
- 多机构协同动作序列
- 位置到达检测和容错处理
