# æ•°æ®é‡‡é›†ä¸å­˜å‚¨æ¶æ„åˆ†æ

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ†ææ—¥æœŸ**: 2025-01-15
**ç³»ç»Ÿç‰ˆæœ¬**: DrillControl v1.x

---

## ä¸€ã€æ ¸å¿ƒé—®é¢˜è§£ç­”

### 1.1 å¤šé‡‡æ ·ç‡æ•°æ®å¯¹é½æœºåˆ¶ âœ…

**é—®é¢˜**ï¼šç³»ç»Ÿä¸­å­˜åœ¨å¤šç§é‡‡æ ·ç‡çš„ä¼ æ„Ÿå™¨
- æŒ¯åŠ¨ä¼ æ„Ÿå™¨ï¼š5000 Hzï¼ˆé«˜é¢‘ï¼‰
- MDBä¼ æ„Ÿå™¨ï¼ˆæ‰­çŸ©/æ‹‰åŠ›ï¼‰ï¼š10 Hzï¼ˆä½é¢‘ï¼‰
- ç”µæœºç¼–ç å™¨ï¼š100 Hzï¼ˆä¸­é¢‘ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š**æ—¶é—´çª—å£ï¼ˆTime Windowsï¼‰å¯¹é½æœºåˆ¶**

#### æ ¸å¿ƒè®¾è®¡

```
æ—¶é—´è½´ï¼ˆå¾®ç§’ï¼‰:
0          1,000,000     2,000,000     3,000,000
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â–º
â”‚ Window 1 â”‚   Window 2   â”‚   Window 3   â”‚
â”‚ (1ç§’)    â”‚   (1ç§’)      â”‚   (1ç§’)      â”‚

æ•°æ®åˆ†é…ç¤ºä¾‹ï¼š
- æŒ¯åŠ¨æ•°æ® timestamp=500,000 us  â†’ Window 1
- MDBæ•°æ®   timestamp=800,000 us  â†’ Window 1
- ç”µæœºæ•°æ®  timestamp=1,200,000 us â†’ Window 2
```

#### å®ç°ç»†èŠ‚

**æ–‡ä»¶ä½ç½®**: `src/database/DbWriter.cpp:537-584`

```cpp
int DbWriter::getOrCreateWindow(int roundId, qint64 timestampUs)
{
    // è®¡ç®—çª—å£èµ·å§‹æ—¶é—´ï¼ˆå‘ä¸‹å–æ•´åˆ°ç§’è¾¹ç•Œï¼‰
    qint64 windowStart = (timestampUs / 1000000) * 1000000;
    qint64 windowEnd = windowStart + 1000000;

    // ç¼“å­˜æŸ¥è¯¢ â†’ æ•°æ®åº“æŸ¥è¯¢ â†’ åˆ›å»ºæ–°çª—å£
    // ...
}
```

**æ—¶é—´çª—å£è¡¨ç»“æ„**:
```sql
CREATE TABLE time_windows (
    window_id INTEGER PRIMARY KEY,
    round_id INTEGER NOT NULL,
    window_start_us INTEGER NOT NULL,  -- çª—å£èµ·å§‹æ—¶é—´ï¼ˆå¾®ç§’ï¼‰
    window_end_us INTEGER NOT NULL,    -- çª—å£ç»“æŸæ—¶é—´
    has_vibration INTEGER DEFAULT 0,   -- æ ‡è®°ï¼šæ˜¯å¦æœ‰æŒ¯åŠ¨æ•°æ®
    has_mdb INTEGER DEFAULT 0,          -- æ ‡è®°ï¼šæ˜¯å¦æœ‰MDBæ•°æ®
    has_motor INTEGER DEFAULT 0,        -- æ ‡è®°ï¼šæ˜¯å¦æœ‰ç”µæœºæ•°æ®
    UNIQUE(round_id, window_start_us)
);
```

#### å¯¹é½ä¼˜åŠ¿

1. **è‡ªåŠ¨å½’æ¡£**ï¼šä¸åŒé‡‡æ ·ç‡çš„æ•°æ®è‡ªåŠ¨æŒ‰æ—¶é—´å½’æ¡£åˆ°åŒä¸€çª—å£
2. **æŸ¥è¯¢é«˜æ•ˆ**ï¼šåªéœ€æŸ¥è¯¢ window_id å³å¯è·å–è¯¥ç§’å†…æ‰€æœ‰ä¼ æ„Ÿå™¨æ•°æ®
3. **æ•°æ®å®Œæ•´æ€§**ï¼šé€šè¿‡ `has_*` å­—æ®µå¿«é€Ÿåˆ¤æ–­å“ªäº›æ•°æ®ç¼ºå¤±
4. **æ—¶é—´åŒæ­¥**ï¼šæ‰€æœ‰æ•°æ®ä»¥å¾®ç§’çº§æ—¶é—´æˆ³ä¸ºå‡†ï¼Œç²¾åº¦ 1Î¼s

---

### 1.2 æ—¶é—´æˆ³ä½¿ç”¨ âœ…

**ä½¿ç”¨ä½ç½®**ï¼š

| å±‚æ¬¡ | æ—¶é—´æˆ³å­—æ®µ | ç²¾åº¦ | æ¥æº |
|------|-----------|------|------|
| DataBlock | `startTimestampUs` | å¾®ç§’ | `QDateTime::currentMSecsSinceEpoch() * 1000` |
| scalar_samples | `timestamp_us` | å¾®ç§’ | æ¯ä¸ªæ ·æœ¬ç‹¬ç«‹è®¡ç®— |
| vibration_samples | `start_timestamp_us` | å¾®ç§’ | æ•°æ®å—èµ·å§‹æ—¶é—´ |
| time_windows | `window_start_us` | å¾®ç§’ | å‘ä¸‹å–æ•´åˆ°ç§’è¾¹ç•Œ |

**è®¡ç®—æ–¹æ³•**ï¼ˆ`DbWriter.cpp:437-440`ï¼‰:
```cpp
qint64 sampleTimestamp = block.startTimestampUs;
if (block.sampleRate > 0 && i > 0) {
    sampleTimestamp += static_cast<qint64>((i * 1000000.0) / block.sampleRate);
}
```

ç¤ºä¾‹ï¼šé‡‡æ ·ç‡ 10 Hzï¼Œç¬¬ 3 ä¸ªæ ·æœ¬çš„æ—¶é—´æˆ³ = start + (2 * 1,000,000 / 10) = start + 200,000 us

---

### 1.3 ä¼ æ„Ÿå™¨/ç”µæœºè¿æ¥æ£€æµ‹ âœ…

#### æ£€æµ‹æœºåˆ¶

**åŸºç±»å®šä¹‰**ï¼ˆ`include/dataACQ/BaseWorker.h:95-100`ï¼‰:
```cpp
virtual bool initializeHardware() = 0;  // å­ç±»å®ç°ï¼šå»ºç«‹è¿æ¥
virtual void shutdownHardware() = 0;    // å­ç±»å®ç°ï¼šå…³é—­è¿æ¥
```

**è¿æ¥çŠ¶æ€æŸ¥è¯¢**:
```cpp
// MdbWorker.h:49
bool isConnected() const { return m_isConnected; }

// MotorWorker.h - åŒæ ·å®ç°
bool isConnected() const;

// VibrationWorker.h - åŒæ ·å®ç°
bool isConnected() const;
```

#### è¿æ¥æ£€æµ‹æ—¶æœº

1. **å¯åŠ¨æ—¶æ£€æµ‹**ï¼š`Worker::start()` â†’ `initializeHardware()`
2. **è¿è¡Œæ—¶ç›‘æ§**ï¼šé‡‡é›†å¾ªç¯ä¸­å‡ºç°é”™è¯¯è‡ªåŠ¨å‘å°„ `errorOccurred` ä¿¡å·
3. **é”™è¯¯ä¼ æ’­**ï¼š`AcquisitionManager` æ¥æ”¶é”™è¯¯å¹¶è½¬å‘ç»™ UI

**ä¿¡å·é“¾**:
```
Worker::errorOccurred
  â†“
AcquisitionManager::errorOccurred(workerName, error)
  â†“
UI (SensorPage / MdbPage / MotorPage)
```

---

### 1.4 ä¸€é”®å¯åœé‡‡é›† âœ…

#### å…¨å±€æ§åˆ¶

**æ–‡ä»¶ä½ç½®**: `include/control/AcquisitionManager.h:52-63`

```cpp
public slots:
    void startAll();   // ä¸€é”®å¯åŠ¨æ‰€æœ‰é‡‡é›†
    void stopAll();    // ä¸€é”®åœæ­¢æ‰€æœ‰é‡‡é›†
```

**å®ç°**ï¼ˆ`src/control/AcquisitionManager.cpp:226-274`ï¼‰:

```cpp
void AcquisitionManager::startAll()
{
    // 1. æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€
    if (!m_isInitialized) return;

    // 2. è‡ªåŠ¨åˆ›å»ºæ–°è½®æ¬¡ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
    if (m_currentRoundId == 0) {
        startNewRound();
    }

    // 3. å¯åŠ¨æ‰€æœ‰Workerï¼ˆè·¨çº¿ç¨‹è°ƒç”¨ï¼‰
    QMetaObject::invokeMethod(m_vibrationWorker, "start", Qt::QueuedConnection);
    QMetaObject::invokeMethod(m_mdbWorker, "start", Qt::QueuedConnection);
    QMetaObject::invokeMethod(m_motorWorker, "start", Qt::QueuedConnection);

    // 4. å‘å°„çŠ¶æ€å˜åŒ–ä¿¡å·
    m_isRunning = true;
    emit acquisitionStateChanged(true);
}

void AcquisitionManager::stopAll()
{
    // åœæ­¢æ‰€æœ‰Worker
    QMetaObject::invokeMethod(m_vibrationWorker, "stop", Qt::QueuedConnection);
    QMetaObject::invokeMethod(m_mdbWorker, "stop", Qt::QueuedConnection);
    QMetaObject::invokeMethod(m_motorWorker, "stop", Qt::QueuedConnection);

    m_isRunning = false;
    emit acquisitionStateChanged(false);
}
```

#### å•ç‹¬æ§åˆ¶

```cpp
void startVibration();  // åªå¯åŠ¨æŒ¯åŠ¨é‡‡é›†
void startMdb();        // åªå¯åŠ¨MDBé‡‡é›†
void startMotor();      // åªå¯åŠ¨ç”µæœºé‡‡é›†
void stopVibration();
void stopMdb();
void stopMotor();
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- è°ƒè¯•å•ä¸ªä¼ æ„Ÿå™¨æ—¶
- åˆ†é˜¶æ®µå¯åŠ¨ç¡¬ä»¶
- é™ä½ç³»ç»Ÿè´Ÿè½½

---

### 1.5 æ•°æ®åº“å­˜å‚¨æœ€ä½³å®è·µ âœ…

#### è¡¨ç»“æ„è®¾è®¡

**æ ¸å¿ƒè¡¨å…³ç³»**:
```
rounds (å®éªŒè½®æ¬¡)
  â”œâ”€â”€ time_windows (æ—¶é—´çª—å£ï¼Œ1ç§’å¯¹é½)
  â”‚     â”œâ”€â”€ scalar_samples (ä½é¢‘æ•°æ®ï¼šMDB + Motor)
  â”‚     â””â”€â”€ vibration_samples (é«˜é¢‘æ•°æ®ï¼šæŒ¯åŠ¨ä¼ æ„Ÿå™¨)
  â”œâ”€â”€ events (äº‹ä»¶è®°å½•)
  â””â”€â”€ frequency_log (é¢‘ç‡å˜åŒ–æ—¥å¿—)
```

#### 1. rounds è¡¨ï¼ˆå®éªŒè½®æ¬¡ç®¡ç†ï¼‰

```sql
CREATE TABLE rounds (
    round_id INTEGER PRIMARY KEY AUTOINCREMENT,
    start_ts_us INTEGER NOT NULL,         -- è½®æ¬¡å¼€å§‹æ—¶é—´
    end_ts_us INTEGER,                     -- è½®æ¬¡ç»“æŸæ—¶é—´ï¼ˆNULLè¡¨ç¤ºè¿›è¡Œä¸­ï¼‰
    status TEXT DEFAULT 'running',         -- çŠ¶æ€ï¼šrunning / completed / error
    operator_name TEXT,                    -- æ“ä½œå‘˜
    note TEXT,                             -- å¤‡æ³¨ï¼ˆå¯å­˜ä»»åŠ¡æ–‡ä»¶åï¼‰
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**è®¾è®¡ç†ç”±**:
- `round_id` è‡ªå¢ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†ä¸€æ¬¡å®éªŒ
- `status` å­—æ®µåŒºåˆ†æ­£å¸¸/å¼‚å¸¸ç»“æŸ
- `note` å­—æ®µå¯å…³è” AutoTask ä»»åŠ¡æ–‡ä»¶

#### 2. time_windows è¡¨ï¼ˆæ—¶é—´çª—å£ï¼‰

```sql
CREATE TABLE time_windows (
    window_id INTEGER PRIMARY KEY,
    round_id INTEGER NOT NULL,
    window_start_us INTEGER NOT NULL,
    window_end_us INTEGER NOT NULL,
    has_vibration INTEGER DEFAULT 0,
    has_mdb INTEGER DEFAULT 0,
    has_motor INTEGER DEFAULT 0,
    UNIQUE(round_id, window_start_us)     -- è”åˆå”¯ä¸€ç´¢å¼•
);

CREATE UNIQUE INDEX idx_tw_round_start
ON time_windows(round_id, window_start_us);
```

**è®¾è®¡ç†ç”±**:
- **1ç§’çª—å£å¯¹é½**ï¼šæ‰€æœ‰æ•°æ®å½’æ¡£åˆ°1ç§’è¾¹ç•Œ
- **æ•°æ®å®Œæ•´æ€§æ ‡è®°**ï¼šå¿«é€Ÿåˆ¤æ–­å“ªäº›ä¼ æ„Ÿå™¨æœ‰æ•°æ®
- **é«˜æ•ˆæŸ¥è¯¢**ï¼šé€šè¿‡è”åˆç´¢å¼•å¿«é€Ÿå®šä½çª—å£

#### 3. scalar_samples è¡¨ï¼ˆä½é¢‘æ ‡é‡æ•°æ®ï¼‰

```sql
CREATE TABLE scalar_samples (
    sample_id INTEGER PRIMARY KEY,
    round_id INTEGER NOT NULL,
    window_id INTEGER NOT NULL,            -- å¤–é”®ï¼štime_windows
    sensor_type INTEGER NOT NULL,          -- ä¼ æ„Ÿå™¨ç±»å‹æšä¸¾
    channel_id INTEGER NOT NULL,
    timestamp_us INTEGER NOT NULL,         -- ç²¾ç¡®æ—¶é—´æˆ³
    value REAL NOT NULL
);

CREATE INDEX idx_scalar_window ON scalar_samples(window_id);
```

**å­˜å‚¨çš„æ•°æ®ç±»å‹**:
- MDBä¼ æ„Ÿå™¨ï¼šæ‰­çŸ©ã€ä¸Šæ‹‰åŠ›ã€ä¸‹æ‹‰åŠ›ã€ä½ç½®
- ç”µæœºå‚æ•°ï¼šä½ç½®ã€é€Ÿåº¦ã€ç”µæµ

#### 4. vibration_samples è¡¨ï¼ˆé«˜é¢‘æŒ¯åŠ¨æ•°æ®ï¼‰

```sql
CREATE TABLE vibration_samples (
    sample_id INTEGER PRIMARY KEY,
    round_id INTEGER NOT NULL,
    window_id INTEGER NOT NULL,
    sensor_type INTEGER NOT NULL,          -- X/Y/Z è½´
    start_timestamp_us INTEGER NOT NULL,
    sample_rate REAL NOT NULL,             -- å®é™…é‡‡æ ·ç‡ï¼ˆHzï¼‰
    num_samples INTEGER NOT NULL,          -- æ ·æœ¬æ•°
    -- ç»Ÿè®¡ç‰¹å¾ï¼ˆé¿å…å­˜å‚¨åŸå§‹æ•°æ®ï¼‰
    min_value REAL,
    max_value REAL,
    mean_value REAL,
    rms_value REAL,
    std_dev REAL,
    -- åŸå§‹æ•°æ®ï¼ˆå¯é€‰ï¼ŒBLOBå‹ç¼©å­˜å‚¨ï¼‰
    raw_data BLOB
);
```

**è®¾è®¡ç†ç”±**:
- **ç»Ÿè®¡ç‰¹å¾ä¼˜å…ˆ**ï¼šå¤§éƒ¨åˆ†åˆ†æåªéœ€è¦ç»Ÿè®¡å€¼ï¼Œä¸éœ€è¦åŸå§‹æ³¢å½¢
- **BLOBå‹ç¼©**ï¼šåŸå§‹æ•°æ®å¯ç”¨ zlib å‹ç¼©åå­˜å‚¨ï¼ŒèŠ‚çœç©ºé—´
- **æŒ‰éœ€å­˜å‚¨**ï¼šé«˜é¢‘æ•°æ®å¯é€‰æ‹©æ€§å­˜å‚¨ï¼ˆé…ç½®é¡¹æ§åˆ¶ï¼‰

#### 5. frequency_log è¡¨ï¼ˆé¢‘ç‡å˜åŒ–è®°å½•ï¼‰

```sql
CREATE TABLE frequency_log (
    log_id INTEGER PRIMARY KEY,
    round_id INTEGER,
    sensor_type INTEGER NOT NULL,
    old_freq REAL,
    new_freq REAL NOT NULL,
    timestamp_us INTEGER NOT NULL,
    comment TEXT
);
```

**ç”¨é€”**ï¼šè®°å½•é‡‡æ ·ç‡åŠ¨æ€è°ƒæ•´å†å²ï¼Œä¾¿äºæ•°æ®åˆ†ææ—¶å›æº¯

---

### 1.6 åŒºåˆ†ä¸åŒå®éªŒç»„ âœ…

#### æ–¹æ³•1ï¼šè½®æ¬¡IDï¼ˆRound IDï¼‰

**æ ¸å¿ƒæœºåˆ¶**:
```cpp
// å¼€å§‹æ–°å®éªŒ
int roundId = manager->startNewRound("å¼ ä¸‰", "E1_D1_HoleAå®éªŒ");

// æ‰€æœ‰æ•°æ®è‡ªåŠ¨å…³è”åˆ°è¯¥roundId
DataBlock block;
block.roundId = roundId;

// ç»“æŸå®éªŒ
manager->endCurrentRound();
```

#### æ–¹æ³•2ï¼šå¤‡æ³¨å­—æ®µï¼ˆNoteï¼‰

**ç¤ºä¾‹**:
```cpp
startNewRound("æ“ä½œå‘˜A", "ä»»åŠ¡æ–‡ä»¶: simple_test.json, åœ°å±‚: è½¯å²©");
```

**æŸ¥è¯¢**:
```sql
SELECT * FROM rounds WHERE note LIKE '%simple_test.json%';
```

#### æ–¹æ³•3ï¼šäº‹ä»¶è®°å½•ï¼ˆEventsï¼‰

```sql
CREATE TABLE events (
    event_id INTEGER PRIMARY KEY,
    round_id INTEGER,
    event_type TEXT NOT NULL,  -- 'START', 'STOP', 'FAULT', 'MANUAL'
    timestamp_us INTEGER NOT NULL,
    description TEXT
);
```

**ç¤ºä¾‹**:
```sql
INSERT INTO events (round_id, event_type, description)
VALUES (5, 'START', 'è‡ªåŠ¨ä»»åŠ¡å¼€å§‹: simple_test.json æ­¥éª¤1');
```

---

### 1.7 ä¸AutoTaskç»“åˆæ–¹æ¡ˆ âš ï¸ å¾…å®ç°

#### å½“å‰çŠ¶æ€

**å·²æœ‰åŸºç¡€**:
- âœ… `AcquisitionManager::startNewRound(operatorName, note)`
- âœ… `AcquisitionManager::endCurrentRound()`
- âœ… AutoTask å¯ä»¥è®¿é—® `AcquisitionManager` å®ä¾‹

**ç¼ºå¤±é›†æˆ**:
- âŒ AutoTask å¯åŠ¨æ—¶æœªè‡ªåŠ¨å¼€å¯æ•°æ®é‡‡é›†
- âŒ æœªå°†ä»»åŠ¡æ–‡ä»¶åè®°å½•åˆ°æ•°æ®åº“
- âŒ ä»»åŠ¡æ­¥éª¤å˜åŒ–æœªè®°å½•åˆ° events è¡¨

#### å»ºè®®å®ç°æ–¹æ¡ˆ

##### æ–¹æ¡ˆAï¼šè½»åº¦é›†æˆï¼ˆæ¨èï¼‰

**ä¿®æ”¹ä½ç½®**: `src/control/AutoDrillManager.cpp:226-256` (`start()` æ–¹æ³•)

```cpp
bool AutoDrillManager::start()
{
    // ç°æœ‰æ£€æŸ¥ä»£ç ...

    // ===== æ–°å¢ï¼šå¯åŠ¨æ•°æ®é‡‡é›† =====
    if (m_acquisitionManager) {
        // åˆ›å»ºæ–°è½®æ¬¡ï¼Œå¤‡æ³¨åŒ…å«ä»»åŠ¡ä¿¡æ¯
        QString note = QString("è‡ªåŠ¨ä»»åŠ¡: %1").arg(m_taskFilePath);
        int roundId = m_acquisitionManager->startNewRound(m_operatorName, note);

        // è®°å½•ä»»åŠ¡å¼€å§‹äº‹ä»¶
        // ï¼ˆéœ€è¦æ·»åŠ  logEvent() æ–¹æ³•åˆ° AcquisitionManagerï¼‰
        m_acquisitionManager->logEvent(roundId, "AUTOTASK_START",
            QString("ä»»åŠ¡æ–‡ä»¶: %1, æ­¥éª¤æ•°: %2").arg(m_taskFilePath).arg(m_steps.size()));

        // å¦‚æœé‡‡é›†æœªè¿è¡Œï¼Œè‡ªåŠ¨å¯åŠ¨
        if (!m_acquisitionManager->isRunning()) {
            m_acquisitionManager->startAll();
        }
    }
    // =============================

    // ç»§ç»­æ‰§è¡Œä»»åŠ¡...
}
```

**ä¿®æ”¹ä½ç½®**: `src/control/AutoDrillManager.cpp:586-639` (`executeStep()` æ–¹æ³•)

```cpp
void AutoDrillManager::executeStep(const TaskStep& step)
{
    // ç°æœ‰ä»£ç ...

    // ===== æ–°å¢ï¼šè®°å½•æ­¥éª¤äº‹ä»¶ =====
    if (m_acquisitionManager && m_acquisitionManager->currentRoundId() > 0) {
        QString stepDesc = QString("æ­¥éª¤ %1/%2: %3 è‡³ %4mm (é¢„è®¾ %5)")
            .arg(m_currentStepIndex + 1)
            .arg(m_steps.size())
            .arg(TaskStep::typeToString(step.type))
            .arg(step.targetDepthMm)
            .arg(step.presetId);

        m_acquisitionManager->logEvent(
            m_acquisitionManager->currentRoundId(),
            "AUTOTASK_STEP",
            stepDesc
        );
    }
    // =============================
}
```

**ä¿®æ”¹ä½ç½®**: `src/control/AutoDrillManager.cpp:670-698` (`failTask()` / `taskCompleted()`)

```cpp
void AutoDrillManager::failTask(const QString& reason)
{
    // ç°æœ‰ä»£ç ...

    // ===== æ–°å¢ï¼šè®°å½•æ•…éšœå¹¶ç»“æŸè½®æ¬¡ =====
    if (m_acquisitionManager) {
        m_acquisitionManager->logEvent(
            m_acquisitionManager->currentRoundId(),
            "AUTOTASK_FAILED",
            reason
        );
        m_acquisitionManager->endCurrentRound();
    }
    // =============================
}

// taskCompleted() åŒæ ·å¤„ç†
```

##### æ–¹æ¡ˆBï¼šæ·±åº¦é›†æˆï¼ˆå¯é€‰ï¼‰

**æ–°å¢å­—æ®µ**ï¼ˆæ•°æ®åº“ schema å‡çº§ï¼‰:
```sql
-- rounds è¡¨å¢åŠ å­—æ®µ
ALTER TABLE rounds ADD COLUMN task_file TEXT;
ALTER TABLE rounds ADD COLUMN task_type TEXT;  -- 'manual', 'autotask'

-- æ–°å»º autotask_steps è¡¨
CREATE TABLE autotask_steps (
    step_id INTEGER PRIMARY KEY,
    round_id INTEGER NOT NULL,
    step_index INTEGER NOT NULL,
    step_type TEXT NOT NULL,
    target_depth_mm REAL,
    preset_id TEXT,
    start_timestamp_us INTEGER,
    end_timestamp_us INTEGER,
    status TEXT DEFAULT 'pending'  -- pending/in_progress/completed/failed
);
```

**ä¼˜åŠ¿**:
- å®Œæ•´è®°å½•ä»»åŠ¡æ‰§è¡Œå†å²
- å¯å›æ”¾ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹
- ç²¾ç¡®å…³è”æ•°æ®ä¸æ­¥éª¤

**ä»£ä»·**:
- éœ€è¦æ•°æ®åº“å‡çº§è„šæœ¬
- ä»£ç å¤æ‚åº¦å¢åŠ 

---

## äºŒã€ç³»ç»Ÿæ¶æ„æ€»ç»“

### 2.1 æ•°æ®æµå‘

```
ä¼ æ„Ÿå™¨ç¡¬ä»¶
  â†“
Workerçº¿ç¨‹ (VibrationWorker / MdbWorker / MotorWorker)
  â”œâ”€ initializeHardware() â†’ æ£€æµ‹è¿æ¥
  â”œâ”€ runAcquisition() â†’ é‡‡é›†å¾ªç¯
  â””â”€ emit dataBlockReady(block)
        â†“
DbWriterçº¿ç¨‹
  â”œâ”€ enqueueDataBlock(block) â†’ é˜Ÿåˆ—ç¼“å†²
  â”œâ”€ processBatch() â†’ æ‰¹é‡äº‹åŠ¡å†™å…¥
  â”œâ”€ getOrCreateWindow() â†’ æ—¶é—´çª—å£å¯¹é½
  â””â”€ writeScalarData() / writeVibrationData()
        â†“
SQLiteæ•°æ®åº“ (drill_data.db)
  â”œâ”€ rounds (å®éªŒè½®æ¬¡)
  â”œâ”€ time_windows (1ç§’å¯¹é½çª—å£)
  â”œâ”€ scalar_samples (ä½é¢‘æ•°æ®)
  â”œâ”€ vibration_samples (é«˜é¢‘æ•°æ®)
  â””â”€ events (äº‹ä»¶è®°å½•)
```

### 2.2 çº¿ç¨‹æ¨¡å‹

| çº¿ç¨‹å | ä½œç”¨ | ä¼˜å…ˆçº§ |
|--------|------|--------|
| VibrationThread | é«˜é¢‘æŒ¯åŠ¨é‡‡é›†ï¼ˆ5000 Hzï¼‰ | å®æ—¶ |
| MdbThread | MDBä¼ æ„Ÿå™¨é‡‡é›†ï¼ˆ10 Hzï¼‰ | æ­£å¸¸ |
| MotorThread | ç”µæœºç¼–ç å™¨é‡‡é›†ï¼ˆ100 Hzï¼‰ | æ­£å¸¸ |
| DbThread | æ•°æ®åº“æ‰¹é‡å†™å…¥ | ä½ |

**çº¿ç¨‹å®‰å…¨**:
- `QMutex` ä¿æŠ¤é˜Ÿåˆ—
- `Qt::QueuedConnection` è·¨çº¿ç¨‹ä¿¡å·
- æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹çš„ SQLite è¿æ¥

### 2.3 æ€§èƒ½ä¼˜åŒ–

**æ‰¹é‡å†™å…¥**:
- é˜Ÿåˆ—ç¼“å†²ï¼šæœ€å¤§ 10000 ä¸ªæ•°æ®å—
- æ‰¹é‡å¤§å°ï¼š200 ä¸ª/æ‰¹
- å†™å…¥é—´éš”ï¼š100ms
- äº‹åŠ¡æ‰¹å¤„ç†ï¼šå‡å°‘ç£ç›˜ I/O

**çª—å£ç¼“å­˜**:
- ç¼“å­˜æœ€è¿‘ 100 ä¸ªçª—å£ ID
- é¿å…é‡å¤æ•°æ®åº“æŸ¥è¯¢
- LRU æ·˜æ±°ç­–ç•¥

**ç´¢å¼•ä¼˜åŒ–**:
```sql
CREATE UNIQUE INDEX idx_tw_round_start ON time_windows(round_id, window_start_us);
CREATE INDEX idx_scalar_window ON scalar_samples(window_id);
CREATE INDEX idx_vibration_window ON vibration_samples(window_id);
```

---

## ä¸‰ã€å¸¸è§æŸ¥è¯¢ç¤ºä¾‹

### 3.1 æŸ¥è¯¢æŸæ¬¡å®éªŒçš„æ‰€æœ‰æ•°æ®

```sql
-- 1. æŸ¥è¯¢å®éªŒåŸºæœ¬ä¿¡æ¯
SELECT * FROM rounds WHERE round_id = 5;

-- 2. æŸ¥è¯¢è¯¥å®éªŒçš„æ—¶é—´çª—å£
SELECT * FROM time_windows WHERE round_id = 5 ORDER BY window_start_us;

-- 3. æŸ¥è¯¢æŸä¸ªçª—å£å†…çš„æ ‡é‡æ•°æ®
SELECT
    sensor_type,
    timestamp_us,
    value
FROM scalar_samples
WHERE window_id = 123
ORDER BY timestamp_us;

-- 4. æŸ¥è¯¢æ‰­çŸ©æ•°æ®ï¼ˆsensor_type = Torque_MDBï¼‰
SELECT
    w.window_start_us,
    s.timestamp_us,
    s.value AS torque_nm
FROM scalar_samples s
JOIN time_windows w ON s.window_id = w.window_id
WHERE w.round_id = 5 AND s.sensor_type = 3  -- Torque_MDB
ORDER BY s.timestamp_us;
```

### 3.2 æŸ¥è¯¢å¤šä¼ æ„Ÿå™¨åŒæ­¥æ•°æ®

```sql
-- æŸ¥è¯¢åŒæ—¶æœ‰ MDB + Motor æ•°æ®çš„çª—å£
SELECT
    window_id,
    window_start_us,
    window_end_us
FROM time_windows
WHERE round_id = 5
  AND has_mdb = 1
  AND has_motor = 1
ORDER BY window_start_us;

-- åœ¨è¿™äº›çª—å£å†…æå–æ‰­çŸ© + ä½ç½®æ•°æ®
SELECT
    w.window_start_us,
    s1.value AS torque_nm,
    s2.value AS position_mm
FROM time_windows w
LEFT JOIN scalar_samples s1 ON w.window_id = s1.window_id AND s1.sensor_type = 3  -- Torque
LEFT JOIN scalar_samples s2 ON w.window_id = s2.window_id AND s2.sensor_type = 9  -- Position
WHERE w.round_id = 5 AND w.has_mdb = 1 AND w.has_motor = 1
ORDER BY w.window_start_us;
```

### 3.3 æŸ¥è¯¢AutoTaskç›¸å…³æ•°æ®

```sql
-- æŸ¥æ‰¾è‡ªåŠ¨ä»»åŠ¡çš„å®éªŒ
SELECT * FROM rounds
WHERE note LIKE '%è‡ªåŠ¨ä»»åŠ¡%'
ORDER BY start_ts_us DESC;

-- æŸ¥è¯¢ä»»åŠ¡äº‹ä»¶
SELECT
    e.timestamp_us,
    e.event_type,
    e.description
FROM events e
WHERE e.round_id = 5 AND e.event_type LIKE 'AUTOTASK%'
ORDER BY e.timestamp_us;

-- æŸ¥è¯¢ä»»åŠ¡æœŸé—´çš„æ‰­çŸ©è¶…é™äº‹ä»¶
SELECT
    e.timestamp_us,
    e.description
FROM events e
WHERE e.round_id = 5
  AND e.event_type = 'FAULT'
  AND e.description LIKE '%TORQUE_LIMIT%';
```

---

## å››ã€å¾…å®ç°åŠŸèƒ½å»ºè®®

### 4.1 é«˜ä¼˜å…ˆçº§

1. **AutoTask é›†æˆ** â­â­â­
   - è‡ªåŠ¨å¼€å§‹/ç»“æŸè½®æ¬¡
   - è®°å½•ä»»åŠ¡æ–‡ä»¶ååˆ° `note` å­—æ®µ
   - è®°å½•æ­¥éª¤äº‹ä»¶åˆ° `events` è¡¨

2. **æ•°æ®å¯¼å‡ºåŠŸèƒ½** â­â­â­
   - å¯¼å‡ºä¸º CSV æ ¼å¼
   - å¯¼å‡ºä¸º HDF5 æ ¼å¼ï¼ˆå¤§æ•°æ®æ¨èï¼‰
   - æŒ‰è½®æ¬¡/æ—¶é—´èŒƒå›´å¯¼å‡º

3. **å®æ—¶å¯è§†åŒ–** â­â­
   - è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ï¼ˆçº¢/ç»¿ç¯ï¼‰
   - å®æ—¶æ›²çº¿æ˜¾ç¤ºï¼ˆæœ€è¿‘10ç§’æ•°æ®ï¼‰

### 4.2 ä¸­ä¼˜å…ˆçº§

4. **æ•°æ®å®Œæ•´æ€§æ£€æŸ¥** â­â­
   - æ£€æµ‹æ•°æ®ä¸¢å¤±ï¼ˆçª—å£å†…ç¼ºå¤±ä¼ æ„Ÿå™¨æ•°æ®ï¼‰
   - é‡‡æ ·ç‡å¼‚å¸¸æ£€æµ‹
   - è‡ªåŠ¨ç”Ÿæˆå¥åº·æŠ¥å‘Š

5. **æ•°æ®å‹ç¼©** â­â­
   - æŒ¯åŠ¨æ•°æ® BLOB zlib å‹ç¼©
   - å®šæœŸå½’æ¡£æ—§æ•°æ®

### 4.3 ä½ä¼˜å…ˆçº§

6. **æ•°æ®åº“å¤‡ä»½** â­
   - å®šæœŸè‡ªåŠ¨å¤‡ä»½
   - å¢é‡å¤‡ä»½æ”¯æŒ

7. **åˆ†å¸ƒå¼é‡‡é›†** â­
   - å¤šæœºåŒæ­¥é‡‡é›†
   - æ—¶é’ŸåŒæ­¥ï¼ˆNTPï¼‰

---

## äº”ã€å…³é”®ä»£ç ä½ç½®ç´¢å¼•

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|------|------|------|
| æ—¶é—´çª—å£å¯¹é½ | `src/database/DbWriter.cpp` | 537-584 |
| æ•°æ®åº“è¡¨åˆ›å»º | `src/database/DbWriter.cpp` | 298-418 |
| ä¸€é”®å¯åœ | `src/control/AcquisitionManager.cpp` | 226-298 |
| è¿æ¥æ£€æµ‹åŸºç±» | `include/dataACQ/BaseWorker.h` | 95-100 |
| æ‰¹é‡å†™å…¥ | `src/database/DbWriter.cpp` | 116-165 |
| è½®æ¬¡ç®¡ç† | `src/database/DbWriter.cpp` | 175-216 |
| AutoTask å¯åŠ¨ | `src/control/AutoDrillManager.cpp` | 226-256 |
| AutoTask æ­¥éª¤æ‰§è¡Œ | `src/control/AutoDrillManager.cpp` | 586-639 |

---

## å…­ã€æ€»ç»“

### âœ… å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

1. **å¤šé‡‡æ ·ç‡å¯¹é½** - æ—¶é—´çª—å£æœºåˆ¶ï¼ˆ1ç§’å¯¹é½ï¼‰
2. **å¾®ç§’çº§æ—¶é—´æˆ³** - ç²¾ç¡®åˆ° 1Î¼s
3. **è¿æ¥æ£€æµ‹** - æ¯ä¸ª Worker æœ‰ `isConnected()` æ–¹æ³•
4. **ä¸€é”®å¯åœ** - `AcquisitionManager::startAll()` / `stopAll()`
5. **å®éªŒåˆ†ç»„** - è½®æ¬¡ï¼ˆRoundï¼‰ç®¡ç†
6. **é«˜æ•ˆå­˜å‚¨** - æ‰¹é‡äº‹åŠ¡ + ç´¢å¼•ä¼˜åŒ–

### âš ï¸ å¾…å®ç°çš„å…³é”®åŠŸèƒ½

1. **AutoTask è‡ªåŠ¨é‡‡é›†** - ä»»åŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨å¼€å¯æ•°æ®è®°å½•
2. **æ­¥éª¤çº§å…³è”** - æ•°æ®ä¸ä»»åŠ¡æ­¥éª¤ç²¾ç¡®å…³è”
3. **å®æ—¶è¿æ¥çŠ¶æ€æŒ‡ç¤º** - UI çº¢ç»¿ç¯æ˜¾ç¤º
4. **æ•°æ®å¯¼å‡ºå·¥å…·** - CSV/HDF5 å¯¼å‡ºåŠŸèƒ½

### ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

1. **è½®æ¬¡å‘½åè§„èŒƒ**:
   ```
   æ ¼å¼: "å®éªŒç¼–å·_å­”å·_åœ°å±‚ç±»å‹"
   ç¤ºä¾‹: "E1_D1_è½¯å²©", "E2_A3_ç¡¬å²©"
   ```

2. **å¤‡æ³¨å­—æ®µåˆ©ç”¨**:
   ```cpp
   startNewRound("å¼ ä¸‰", "ä»»åŠ¡:simple_test.json,æ·±åº¦:50mm,é¢„è®¾:P2");
   ```

3. **äº‹ä»¶è®°å½•ä¹ æƒ¯**:
   ```cpp
   logEvent(roundId, "MANUAL", "æ“ä½œå‘˜æ‰‹åŠ¨è°ƒæ•´æ‰­çŸ©é™åˆ¶è‡³1800Nm");
   ```

---

**æ–‡æ¡£ç»´æŠ¤**: å¦‚æ¶æ„å‡çº§ï¼Œè¯·åŒæ­¥æ›´æ–°æœ¬æ–‡æ¡£
**åé¦ˆæ¸ é“**: å‘ç°é—®é¢˜æˆ–æœ‰å»ºè®®è¯·æäº¤ Issue
