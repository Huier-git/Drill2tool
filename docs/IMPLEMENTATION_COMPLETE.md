# å¤šé¢‘ç‡ä¼ æ„Ÿå™¨æ•°æ®åº“ v2.0 åŠŸèƒ½æ€»ç»“

## å®ç°å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆæ ¸å¿ƒåŠŸèƒ½

1. **æ•°æ®åº“æ¶æ„ (schema_v2.sql)**
   - 7å¼ è¡¨ï¼Œæ ¸å¿ƒæ˜¯ `time_windows` æ—¶é—´çª—å£è¡¨
   - å›ºå®š1ç§’çª—å£ï¼Œæ‰€æœ‰æ•°æ®è‡ªåŠ¨å¯¹é½
   - BLOB + é¢„è®¡ç®—ç»Ÿè®¡ï¼ˆmin/max/mean/rmsï¼‰

2. **æ•°æ®å†™å…¥ (DbWriter)**
   - æ—¶é—´çª—å£ç®¡ç†ï¼ˆè‡ªåŠ¨åˆ›å»ºã€ç¼“å­˜ï¼‰
   - æŒ¯åŠ¨æ•°æ®ç»Ÿè®¡é¢„è®¡ç®—
   - æ ‡é‡æ•°æ®çª—å£å…³è”
   - æ‰¹é‡äº‹åŠ¡å†™å…¥

3. **æ•°æ®æŸ¥è¯¢ (DataQuerier)**
   - æŒ‰çª—å£æŸ¥è¯¢æ‰€æœ‰æ•°æ®
   - æ—¶é—´èŒƒå›´æ‰¹é‡æŸ¥è¯¢
   - å¿«é€Ÿç»Ÿè®¡æŸ¥è¯¢ï¼ˆä¸è§£æBLOBï¼‰
   - è½®æ¬¡ç®¡ç†

## æ ¸å¿ƒç‰¹æ€§

### ğŸ¯ æ—¶é—´çª—å£å¯¹é½æœºåˆ¶

**åŸç†**ï¼š
```cpp
// çª—å£èµ·å§‹æ—¶é—´ = å‘ä¸‹å–æ•´åˆ°ç§’è¾¹ç•Œ
qint64 windowStart = (timestampUs / 1000000) * 1000000;
```

**æ•ˆæœ**ï¼š
- 5000HzæŒ¯åŠ¨æ•°æ® â†’ æ¯ç§’5000ä¸ªç‚¹ â†’ å…³è”åˆ°1ä¸ªçª—å£
- 10Hz MDBæ•°æ® â†’ æ¯ç§’10ä¸ªç‚¹ â†’ å…³è”åˆ°åŒä¸€ä¸ªçª—å£
- 100Hzç”µæœºæ•°æ® â†’ æ¯ç§’100ä¸ªç‚¹ â†’ å…³è”åˆ°åŒä¸€ä¸ªçª—å£

**æŸ¥è¯¢æŸ1ç§’çš„æ•°æ®**ï¼š
```cpp
WindowData data = querier.getWindowData(roundId, windowStartUs);
// è¿”å›ï¼š5000ä¸ªæŒ¯åŠ¨ç‚¹ + 10ä¸ªMDBç‚¹ + 100ä¸ªç”µæœºç‚¹
```

### ğŸ“Š é¢„è®¡ç®—ç»Ÿè®¡

æŒ¯åŠ¨æ•°æ®å†™å…¥æ—¶è‡ªåŠ¨è®¡ç®—ç»Ÿè®¡ç‰¹å¾ï¼š
- min_value - æœ€å°å€¼
- max_value - æœ€å¤§å€¼
- mean_value - å¹³å‡å€¼
- rms_value - å‡æ–¹æ ¹å€¼

**å¥½å¤„**ï¼š
- å¿«é€Ÿé¢„è§ˆæ•°æ®ï¼ˆä¸éœ€è¦è§£æBLOBï¼‰
- å®æ—¶ç›‘æ§ï¼ˆç›´æ¥è¯»å–RMSå€¼ï¼‰
- æ•°æ®å¯è§†åŒ–ï¼ˆå¿«é€Ÿç»˜åˆ¶è¶‹åŠ¿å›¾ï¼‰

## ä½¿ç”¨æµç¨‹

### 1. æ•°æ®é‡‡é›†é˜¶æ®µ

```
Workeré‡‡é›†æ•°æ® â†’ DataBlock
    â†“
DbWriter.enqueueDataBlock()
    â†“
getOrCreateWindow() â†’ è‡ªåŠ¨åˆ›å»º/æŸ¥æ‰¾çª—å£
    â†“
writeVibrationData() / writeScalarData()
    â†“
SQLiteæ•°æ®åº“ï¼ˆæŒ‰çª—å£å­˜å‚¨ï¼‰
```

### 2. æ•°æ®æŸ¥è¯¢é˜¶æ®µ

```
DataQuerier.initialize()
    â†“
getWindowTimestamps() â†’ è·å–æ‰€æœ‰çª—å£åˆ—è¡¨
    â†“
getWindowData() â†’ æŸ¥è¯¢æŸçª—å£çš„æ‰€æœ‰æ•°æ®
    â†“
å¤„ç†æ•°æ®ï¼ˆåˆ†æ/å¯¼å‡º/å¯è§†åŒ–ï¼‰
```

## å…¸å‹ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå®æ—¶ç›‘æ§

```cpp
// æŸ¥è¯¢æœ€æ–°çª—å£çš„æŒ¯åŠ¨RMSå€¼
auto stats = querier.getVibrationStats(roundId, channelId, startTime, endTime);
if (!stats.isEmpty()) {
    double rms = stats.last().rmsValue;
    if (rms > threshold) {
        // è§¦å‘æŠ¥è­¦
    }
}
```

### åœºæ™¯2ï¼šæ•°æ®å¯¼å‡º

```cpp
// å¯¼å‡ºæŸæ®µæ—¶é—´çš„æ‰€æœ‰æ•°æ®
QList<WindowData> dataList = querier.getTimeRangeData(roundId, startTime, endTime);

// é€çª—å£å†™å…¥CSV
for (const WindowData &window : dataList) {
    exportToCsv(window);
}
```

### åœºæ™¯3ï¼šæ•°æ®åˆ†æ

```cpp
// åˆ†ææŒ¯åŠ¨è¶‹åŠ¿
QList<qint64> windows = querier.getWindowTimestamps(roundId);

for (qint64 ts : windows) {
    WindowData data = querier.getWindowData(roundId, ts);

    // åˆ†æè¯¥çª—å£å†…çš„æ•°æ®
    analyzeVibration(data.vibrationData);
    analyzeForce(data.scalarData);
}
```

## æ€§èƒ½ç‰¹ç‚¹

| ç‰¹æ€§ | å®ç°æ–¹å¼ | æ€§èƒ½ |
|------|---------|------|
| **çª—å£æŸ¥æ‰¾** | ç¼“å­˜100ä¸ªçª—å£ID | O(1) |
| **ç»Ÿè®¡æŸ¥è¯¢** | ç›´æ¥è¯»é¢„è®¡ç®—å€¼ | æå¿« |
| **BLOBè§£æ** | æŒ‰éœ€è§£æ | èŠ‚çœCPU |
| **æ‰¹é‡å†™å…¥** | äº‹åŠ¡+æ‰¹é‡SQL | é«˜åå |

## å­˜å‚¨ç©ºé—´ä¼°ç®—

**1å°æ—¶é‡‡é›†æ•°æ®**ï¼š
- æŒ¯åŠ¨ï¼š5000Hz Ã— 3é€šé“ Ã— 4å­—èŠ‚ = 216MB
- MDBï¼š10Hz Ã— 4ä¼ æ„Ÿå™¨ Ã— 8å­—èŠ‚ = 1.1MB
- ç”µæœºï¼š100Hz Ã— 8ç”µæœº Ã— 4å‚æ•° Ã— 8å­—èŠ‚ = 92MB
- ç»Ÿè®¡+ç´¢å¼•ï¼šçº¦10MB
- **æ€»è®¡**ï¼šçº¦ **320MB/å°æ—¶**

## æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶

```
D:\KT_DrillControl\
â”œâ”€â”€ database/
â”‚   â””â”€â”€ schema_v2.sql                  # æ•°æ®åº“å»ºè¡¨SQL
â”œâ”€â”€ include/database/
â”‚   â”œâ”€â”€ DbWriter.h                     # æ•°æ®å†™å…¥ç±»ï¼ˆå·²å‡çº§ï¼‰
â”‚   â””â”€â”€ DataQuerier.h                  # æ•°æ®æŸ¥è¯¢ç±»ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ src/database/
â”‚   â”œâ”€â”€ DbWriter.cpp                   # å†™å…¥å®ç°
â”‚   â””â”€â”€ DataQuerier.cpp                # æŸ¥è¯¢å®ç°
â””â”€â”€ docs/
    â””â”€â”€ QUERY_USAGE_EXAMPLE.md         # ä½¿ç”¨ç¤ºä¾‹æ–‡æ¡£
```

### ä¿®æ”¹çš„æ–‡ä»¶

```
include/database/DbWriter.h            # æ·»åŠ çª—å£ç®¡ç†æ¥å£
src/database/DbWriter.cpp              # å®ç°çª—å£ç®¡ç†ã€ç»Ÿè®¡é¢„è®¡ç®—
DrillControl.pro                       # æ·»åŠ DataQuerieråˆ°ç¼–è¯‘
```

## ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³å¯åš

1. **ç¼–è¯‘æµ‹è¯•**
   ```bash
   qmake && nmake
   ```

2. **æ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•**
   ```cpp
   DbWriter writer("test.db");
   writer.initialize();  // è‡ªåŠ¨åˆ›å»ºv2è¡¨ç»“æ„
   ```

3. **å†™å…¥æµ‹è¯•**
   - å¯åŠ¨æ•°æ®é‡‡é›†
   - è§‚å¯Ÿ time_windows è¡¨æ˜¯å¦è‡ªåŠ¨åˆ›å»º
   - éªŒè¯æ•°æ®æ˜¯å¦æŒ‰çª—å£å­˜å‚¨

4. **æŸ¥è¯¢æµ‹è¯•**
   ```cpp
   DataQuerier querier("test.db");
   querier.initialize();
   auto windows = querier.getWindowTimestamps(1);
   auto data = querier.getWindowData(1, windows.first());
   ```

### è¿›é˜¶åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

1. **CSVå¯¼å‡ºåŠŸèƒ½**
   - åœ¨SensorPageæ·»åŠ "å¯¼å‡º"æŒ‰é’®
   - è°ƒç”¨DataQuerierå¯¼å‡ºæ•°æ®

2. **å®æ—¶æ•°æ®é¢„è§ˆ**
   - ä½¿ç”¨getVibrationStatså¿«é€ŸæŸ¥è¯¢
   - ç»˜åˆ¶å®æ—¶æ›²çº¿å›¾

3. **äº‹ä»¶æ ‡è®°åŠŸèƒ½**
   - æ·»åŠ æ‰‹åŠ¨æ ‡è®°æ¥å£
   - è®°å½•å¼‚å¸¸äº‹ä»¶

## æŠ€æœ¯ç‰¹ç‚¹æ€»ç»“

âœ… **KISSåŸåˆ™**ï¼šä»£ç ç®€æ´ï¼Œé€»è¾‘æ¸…æ™°
âœ… **ç¬¬ä¸€æ€§åŸç†**ï¼šçª—å£å¯¹é½æ˜¯æœ€æœ¬è´¨çš„è§£å†³æ–¹æ¡ˆ
âœ… **æ¸è¿›å¼å¼€å‘**ï¼šå…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½ï¼Œå†é”¦ä¸Šæ·»èŠ±
âœ… **é²æ£’æ€§å¥½**ï¼šçª—å£ç¼“å­˜ã€é”™è¯¯å¤„ç†ã€äº‹åŠ¡ä¿è¯

---

**å®Œæˆæ—¥æœŸ**ï¼š2025-01-25
**æ•°æ®åº“ç‰ˆæœ¬**ï¼šv2.0
**æ ¸å¿ƒåŠŸèƒ½çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œå¯æµ‹è¯•ä½¿ç”¨
